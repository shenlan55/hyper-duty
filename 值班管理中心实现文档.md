# 值班管理中心实现文档

## 📋 项目概述

本文档记录了值班管理系统的完整实现，包括基础信息管理、排班计划管理、请假调班管理、报表统计和系统权限管理五大模块。

## 🗄️ 数据库设计

### 表结构总览

**系统基础表（9个）**
1. sys_dept - 部门表
2. sys_employee - 人员表
3. sys_user - 用户表
4. sys_menu - 菜单表
5. sys_role - 角色表
6. sys_user_role - 用户角色关联表
7. sys_role_menu - 角色菜单关联表
8. duty_schedule - 值班表
9. duty_schedule_employee - 值班表人员关联表
10. duty_assignment - 值班安排表
11. duty_record - 值班记录表

**值班管理扩展表（10个）**
1. duty_shift_config - 班次配置表
2. duty_schedule_rule - 排班规则配置表
3. employee_available_time - 人员可排班时段表
4. leave_request - 请假申请表
5. approval_record - 审批记录表
6. swap_request - 调班记录表
7. operation_log - 操作日志表
8. schedule_version - 排班版本表
9. notification - 消息通知表
10. duty_statistics - 排班统计表

**总计：20个表**

### 新增表结构

#### 1. 值班表人员关联表 (duty_schedule_employee)
管理值班表与人员的关联关系，支持值班长设置。

**字段说明:**
- `schedule_id`: 值班表ID
- `employee_id`: 员工ID
- `is_leader`: 是否是值班长（0-否,1-是）
- `sort_order`: 排序序号

#### 2. 班次配置表 (duty_shift_config)
管理班次的基本信息，包括班次类型、上下班时间、时长等。

**字段说明:**
- `shift_name`: 班次名称
- `shift_code`: 班次编码（唯一）
- `shift_type`: 班次类型（1-早班,2-中班,3-晚班,4-全天,5-夜班）
- `start_time`: 上班时间
- `end_time`: 下班时间
- `duration_hours`: 时长（小时）
- `break_hours`: 休息时长（小时）
- `is_overtime_shift`: 是否加班班次
- `status`: 状态（0-禁用,1-启用）

#### 3. 排班规则配置表 (duty_schedule_rule)
定义排班的规则，包括周期、负载上限、替补优先级等。

**字段说明:**
- `rule_name`: 规则名称
- `rule_code`: 规则编码（唯一）
- `schedule_cycle`: 排班周期（1-按周,2-按月,3-按季度）
- `max_daily_shifts`: 每日最大班次数
- `max_weekly_hours`: 每周最大工作时长
- `max_monthly_hours`: 每月最大工作时长
- `min_rest_days`: 每月最少休息天数
- `substitute_priority_rule`: 替补优先级规则
- `conflict_detection_rule`: 冲突检测规则

#### 4. 人员可排班时段表 (employee_available_time)
记录每个员工在每周各天的可排班时间段。

**字段说明:**
- `employee_id`: 员工ID
- `day_of_week`: 星期（1-周一,2-周二...7-周日）
- `start_time`: 开始时间
- `end_time`: 结束时间
- `is_available`: 是否可用

#### 5. 请假申请表 (leave_request)
记录员工的请假申请信息。

**字段说明:**
- `request_no`: 申请编号（唯一）
- `employee_id`: 申请人ID
- `schedule_id`: 值班表ID
- `leave_type`: 请假类型（1-事假,2-病假,3-年假,4-调休,5-其他）
- `start_date`: 开始日期
- `end_date`: 结束日期
- `start_time`: 开始时间
- `end_time`: 结束时间
- `total_hours`: 请假总时长（小时）
- `reason`: 请假原因
- `attachment_url`: 附件URL
- `approval_status`: 审批状态（pending-待审批,approved-已通过,rejected-已拒绝,cancelled-已取消）
- `current_approver_id`: 当前审批人ID
- `approval_level`: 当前审批层级
- `total_approval_levels`: 总审批层级
- `substitute_employee_id`: 替补人员ID
- `substitute_type`: 替补类型（1-自动,2-手动）
- `substitute_status`: 替补状态（pending-待确认,confirmed-已确认,rejected-已拒绝）
- `reject_reason`: 拒绝原因
- `approval_opinion`: 审批意见
- `schedule_completed`: 排班是否完成（0-未完成,1-已完成）
- `schedule_completed_time`: 排班完成时间
- `schedule_completed_by`: 排班完成人ID
- `create_time`: 创建时间
- `update_time`: 更新时间

#### 6. 审批记录表 (approval_record)
记录审批历史，支持多级审批。

**字段说明:**
- `request_id`: 申请ID
- `request_type`: 申请类型（leave-请假,swap-调班）
- `approver_id`: 审批人ID
- `approval_level`: 审批层级
- `approval_status`: 审批状态（approved-通过,rejected-拒绝）
- `approval_opinion`: 审批意见
- `approval_time`: 审批时间
- `create_time`: 创建时间

#### 7. 调班记录表 (swap_request)
记录调班申请信息。

**字段说明:**
- `request_no`: 申请编号
- `original_employee_id`: 原值班人员ID
- `target_employee_id`: 目标值班人员ID
- `original_assignment_id`: 原值班安排ID
- `target_assignment_id`: 目标值班安排ID
- `swap_date`: 调班日期
- `swap_shift`: 调班班次
- `reason`: 调班原因
- `approval_status`: 审批状态（pending-待审批,approved-已通过,rejected-已拒绝,cancelled-已取消）
- `current_approver_id`: 当前审批人ID
- `approval_level`: 当前审批层级
- `total_approval_levels`: 总审批层级
- `original_confirm_status`: 原人员确认状态
- `target_confirm_status`: 目标人员确认状态
- `reject_reason`: 拒绝原因
- `create_time`: 创建时间
- `update_time`: 更新时间

#### 8. 操作日志表 (operation_log)
记录系统操作日志，用于审计。

**字段说明:**
- `operator_id`: 操作人ID（默认值为NULL，避免外键约束失败）
- `operator_name`: 操作人姓名
- `operation_type`: 操作类型
- `operation_module`: 操作模块
- `operation_desc`: 操作描述
- `request_method`: 请求方法
- `request_url`: 请求URL
- `request_params`: 请求参数
- `response_result`: 响应结果
- `ip_address`: IP地址
- `user_agent`: 用户代理
- `execution_time`: 执行时间(毫秒)
- `status`: 状态（0-失败,1-成功）
- `error_msg`: 错误信息
- `create_time`: 创建时间

#### 9. 排班版本表 (schedule_version)
管理排班计划的版本，支持多版本对比。

**字段说明:**
- `schedule_id`: 值班表ID
- `version_name`: 版本名称
- `version_code`: 版本编码
- `start_date`: 开始日期
- `end_date`: 结束日期
- `status`: 状态（draft-草稿,published-已发布,archived-已归档）
- `is_current`: 是否当前版本
- `create_time`: 创建时间
- `update_time`: 更新时间

#### 10. 消息通知表 (notification)
记录系统消息通知，用于提醒用户。

**字段说明:**
- `receiver_id`: 接收人ID
- `receiver_name`: 接收人姓名
- `title`: 通知标题
- `content`: 通知内容
- `type`: 通知类型
- `status`: 状态（unread-未读,read-已读）
- `related_id`: 关联ID
- `related_type`: 关联类型
- `create_time`: 创建时间
- `read_time`: 阅读时间

#### 11. 排班统计表 (duty_statistics)
记录排班统计数据。

**字段说明:**
- `dept_id`: 部门ID
- `dept_name`: 部门名称
- `total_schedules`: 总排班数
- `total_assignments`: 总值班安排数
- `total_records`: 总值班记录数
- `avg_daily_hours`: 日均时长
- `total_overtime_hours`: 总加班时长
- `total_leave_requests`: 总请假申请数
- `stat_date`: 统计日期
- `create_time`: 创建时间

### 修改的表

#### duty_assignment 表
新增字段:
- `shift_config_id`: 班次配置ID
- `version_id`: 排班版本ID
- `is_overtime`: 是否加班

#### duty_record 表
新增字段:
- `substitute_employee_id`: 替补人员ID
- `substitute_type`: 替补类型

## 🔧 后端实现

### 实体类（Entity）- 20个

1. **SysDept** - 部门实体
2. **SysEmployee** - 人员实体
3. **SysUser** - 用户实体
4. **SysMenu** - 菜单实体
5. **SysRole** - 角色实体
6. **SysUserRole** - 用户角色关联实体
7. **SysRoleMenu** - 角色菜单关联实体
8. **DutySchedule** - 值班表实体
9. **DutyScheduleEmployee** - 值班表人员关联实体
10. **DutyAssignment** - 值班安排实体
11. **DutyRecord** - 值班记录实体
12. **DutyShiftConfig** - 班次配置实体
13. **DutyScheduleRule** - 排班规则实体
14. **EmployeeAvailableTime** - 人员可排班时段实体
15. **LeaveRequest** - 请假申请实体
16. **ApprovalRecord** - 审批记录实体
17. **SwapRequest** - 调班记录实体
18. **OperationLog** - 操作日志实体
19. **ScheduleVersion** - 排班版本实体
20. **Notification** - 消息通知实体

### Mapper接口 - 20个

所有实体类都对应创建了Mapper接口，继承自BaseMapper。

### Service层

#### 核心Service（20个）

1. **SysDeptService** - 部门管理服务
2. **SysEmployeeService** - 人员管理服务
3. **SysUserService** - 用户管理服务
4. **SysMenuService** - 菜单管理服务
5. **SysRoleService** - 角色管理服务
6. **SysUserRoleService** - 用户角色关联服务
7. **SysRoleMenuService** - 角色菜单关联服务
8. **DutyScheduleService** - 值班表管理服务
9. **DutyScheduleEmployeeService** - 值班表人员关联服务
10. **DutyAssignmentService** - 值班安排服务
11. **DutyRecordService** - 值班记录服务
12. **DutyShiftConfigService** - 班次配置服务
13. **DutyScheduleRuleService** - 排班规则服务
14. **EmployeeAvailableTimeService** - 人员可排班时段服务
15. **LeaveRequestService** - 请假申请服务
16. **ApprovalRecordService** - 审批记录服务
17. **SwapRequestService** - 调班申请服务
18. **OperationLogService** - 操作日志服务
19. **ScheduleVersionService** - 排班版本服务
20. **NotificationService** - 消息通知服务

#### 扩展Service（3个）

1. **AutoScheduleService** - 自动排班服务
   - `generateAutoSchedule()` - 生成自动排班（轮换排班）
   - `generateAutoScheduleByWorkHours()` - 生成自动排班（按工时均衡排班）
   - `checkConflict()` - 检测排班冲突
   - `getAvailableEmployees()` - 获取可用员工
   - `getEmployeeMonthlyWorkHours()` - 获取员工本月工时

2. **DutyStatisticsService** - 排班统计服务
   - `getOverallStatistics()` - 获取总体统计
   - `getDeptStatistics()` - 获取部门统计
   - `getShiftDistribution()` - 获取班次分布
   - `getMonthlyTrend()` - 获取月度趋势

3. **ExportService** - 报表导出服务
   - `exportDutyAssignments()` - 导出值班安排
   - `exportDutyRecords()` - 导出值班记录
   - `exportLeaveRequests()` - 导出请假申请

### Controller层 - 18个

1. **SysDeptController** - 部门管理控制器
2. **SysEmployeeController** - 人员管理控制器
3. **SysUserController** - 用户管理控制器
4. **SysMenuController** - 菜单管理控制器
5. **SysRoleController** - 角色管理控制器
6. **DutyScheduleController** - 值班表管理控制器
7. **DutyAssignmentController** - 值班安排控制器
8. **DutyRecordController** - 值班记录控制器
9. **DutyShiftConfigController** - 班次配置控制器
10. **DutyScheduleModeController** - 排班模式控制器
11. **LeaveRequestController** - 请假申请控制器
12. **LeaveApprovalController** - 请假审批控制器
13. **SwapRequestController** - 调班管理控制器
14. **DutyStatisticsController** - 排班统计控制器
15. **OperationLogController** - 操作日志控制器
16. **AutoScheduleController** - 自动排班控制器
17. **ExportController** - 报表导出控制器
18. **NotificationController** - 消息通知控制器

### 工具类

1. **ExcelExportUtil** - Excel导出工具类
   - `exportDutyAssignments()` - 导出值班安排
   - `exportDutyRecords()` - 导出值班记录
   - `exportLeaveRequests()` - 导出请假申请
   - 自动列宽调整
   - 样式设置

## 🎨 前端实现

### 页面组件（Vue）- 10个

**值班管理页面（9个）**
1. **DutySchedule.vue** - 值班表管理
2. **DutyAssignment.vue** - 值班安排
3. **DutyRecord.vue** - 值班记录
4. **ShiftConfig.vue** - 班次配置
5. **LeaveRequest.vue** - 请假申请
6. **LeaveApproval.vue** - 请假审批
7. **SwapRequest.vue** - 调班管理
8. **Statistics.vue** - 排班统计
9. **OperationLog.vue** - 操作日志

**其他页面（1个）**
1. **DutyLayout.vue** - 值班管理布局

### API封装（JavaScript）- 10个

1. **schedule.js** - 值班表管理API
2. **assignment.js** - 值班安排API
3. **record.js** - 值班记录API
4. **shiftConfig.js** - 班次配置API
5. **leaveRequest.js** - 请假申请API
6. **leaveApproval.js** - 请假审批API
7. **swapRequest.js** - 调班管理API
8. **statistics.js** - 排班统计API
9. **operationLog.js** - 操作日志API
10. **notification.js** - 消息通知API

### 路由配置

**值班管理子路由（8个）**
1. `/duty/schedule` - 值班表管理
2. `/duty/assignment` - 值班安排
3. `/duty/record` - 值班记录
4. `/duty/shift-config` - 班次配置
5. `/duty/leave-request` - 请假申请
6. `/duty/leave-approval` - 请假审批
7. `/duty/swap-request` - 调班管理
8. `/duty/statistics` - 排班统计

**系统管理子路由（7个）**
1. `/system/dept` - 部门管理
2. `/system/employee` - 人员管理
3. `/system/user` - 用户管理
4. `/system/menu` - 菜单管理
5. `/system/role` - 角色管理
6. `/system/dict` - 字典管理
7. `/system/operation-log` - 操作日志

### 菜单注册

**系统菜单（17个）**
1. 首页
2. 系统管理
3. 部门管理
4. 人员管理
5. 用户管理
6. 菜单管理
7. 角色管理
8. 字典管理
9. 操作日志
10. 值班管理
11. 值班表管理
12. 值班安排
13. 值班记录
14. 班次配置
15. 请假申请
16. 请假审批
17. 调班管理
18. 排班统计

**菜单权限分配**
- 超级管理员（ROLE_ADMIN）：拥有所有菜单权限
- 普通用户（ROLE_USER）：拥有基础菜单权限

## 🎯 核心功能实现

### 1. 自动排班算法

**实现位置**: [AutoScheduleServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/AutoScheduleServiceImpl.java)

**核心逻辑**:
- 负载均衡：根据员工当前工作时长和班次数量进行均衡分配
- 可用性检查：检查员工的可排班时段
- 冲突检测：避免重复排班
- 规则限制：
  - 每日最大班次数限制
  - 每周最大工作时长限制
  - 每月最大工作时长限制
- 优先级排序：
  - 工作时长少的员工优先
  - 班次数量少的员工优先
  - 同部门员工优先

**API接口**:
- `POST /duty/auto-schedule/generate` - 生成自动排班（轮换排班）
- `POST /duty/auto-schedule/generate-by-work-hours` - 生成自动排班（按工时均衡排班）
- `POST /duty/auto-schedule/generate-by-mode` - 根据排班模式生成自动排班
- `GET /duty/auto-schedule/check-conflict` - 检测排班冲突
- `GET /duty/auto-schedule/available-employees` - 获取可用员工
- `GET /duty/auto-schedule/employee-monthly-work-hours` - 获取员工本月工时

### 1.1 排班模式管理

**实现位置**:
- [DutyScheduleMode.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/entity/DutyScheduleMode.java)
- [DutyHoliday.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/entity/DutyHoliday.java)
- [ScheduleAlgorithm.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/algorithm/ScheduleAlgorithm.java)
- [FourDayRotationAlgorithm.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/algorithm/impl/FourDayRotationAlgorithm.java)
- [ThreeDayRotationAlgorithm.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/algorithm/impl/ThreeDayRotationAlgorithm.java)
- [DaytimeAllNightShiftRotationAlgorithm.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/algorithm/impl/DaytimeAllNightShiftRotationAlgorithm.java)

**核心逻辑**:
- 排班模式管理：支持多种预定义的排班模式
- 算法接口设计：采用策略模式，支持灵活扩展
- 节假日处理：自动识别节假日，支持批量排班时跳过节假日
- 配置参数化：支持按模式配置不同的参数

**支持的排班模式**:
1. **四天一轮排班**
   - 规则：第一天白班，第二天夜班，第三天休息，第四天休息，周期性轮换
   - 参数：每组人数

2. **三天一轮排班**
   - 规则：第一天白班+夜班，第二天休息，第三天休息，周期性轮换
   - 参数：每组人数

3. **白班全员夜班轮值**
   - 规则：白天组内所有人都值班，晚上按指定人数轮值
   - 参数：夜班值班人数

**数据库表结构**:
- `duty_schedule_mode`：存储排班模式信息，包括模式名称、编码、类型、算法类名、配置参数等
- `duty_holiday`：存储节假日信息，包括节假日名称、日期、是否调休等

**API接口**:
- `POST /duty/auto-schedule/generate-by-mode` - 根据排班模式生成自动排班
- `GET /duty/schedule-mode/list` - 获取启用的排班模式列表
- `GET /duty/schedule-mode/getById` - 根据ID获取排班模式
- `GET /duty/holiday/check` - 检查指定日期是否为节假日

### 2. 冲突检测逻辑

**实现位置**: [AutoScheduleServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/AutoScheduleServiceImpl.java)

**检测类型**:
- 重复排班检测：同一员工同一天同一班次重复排班
- 超负载检测：超过每日最大班次数
- 超时长检测：超过每周/每月最大工作时长
- 可用性检测：不在可排班时段内

### 3. 值班长权限控制

**实现位置**: 
- [DutyScheduleController.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/controller/DutyScheduleController.java)
- [DutyAssignment.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/duty/DutyAssignment.vue)

**核心逻辑**:
- 值班长设置：值班表可以设置多个值班长
- 权限验证：只有值班长才能进行排班操作
- 前端控制：根据当前用户是否是值班长，控制按钮和操作的显示
- 后端验证：登录接口返回 employeeId，用于权限判断

**功能特性**:
- 值班长设置：支持为值班表设置多个值班长
- 批量排班：只有值班长才能使用批量排班功能
- 手动排班：只有值班长才能点击日历上的+号进行排班
- 编辑排班：只有值班长才能编辑排班记录
- 批量清空：只有值班长才能批量清空日期范围的排班

**API接口**:
- `GET /duty/schedule/{id}/employees` - 获取值班人员列表
- `GET /duty/schedule/{id}/leaders` - 获取值班长列表
- `PUT /duty/schedule/{id}/employees` - 更新值班人员
- `PUT /duty/schedule/{id}/leaders` - 更新值班长
- `PUT /duty/schedule/{id}/employees-and-leaders` - 同时更新值班人员和值班长
- `GET /duty/assignment/list/{scheduleId}` - 根据值班表ID获取值班安排
- `POST /duty/assignment/batch` - 批量添加值班安排
- `DELETE /duty/assignment/batch-delete` - 批量删除排班

### 4. 批量清空排班功能

**实现位置**: 
- [DutyAssignmentController.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/controller/DutyAssignmentController.java)
- [DutyAssignmentService.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/DutyAssignmentService.java)
- [DutyAssignment.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/duty/DutyAssignment.vue)

**核心逻辑**:
- 日期范围选择：支持选择开始日期和结束日期
- 二次确认：点击确认前弹出确认对话框
- 批量删除：根据值班表ID和日期范围删除所有排班
- 权限控制：只有值班长才能使用批量清空功能

**功能特性**:
- 日期范围选择器
- 警告提示：清空操作不可恢复
- 二次确认：防止误操作
- 操作反馈：清空成功后显示成功消息

**API接口**:
- `DELETE /duty/assignment/batch-delete` - 批量删除排班

### 5. 请假申请功能

**实现位置**: 
- [LeaveRequestController.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/controller/LeaveRequestController.java)
- [LeaveRequestService.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/LeaveRequestService.java)
- [LeaveRequestServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/LeaveRequestServiceImpl.java)
- [LeaveRequest.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/duty/LeaveRequest.vue)

**核心逻辑**:
- 值班表选择：用户提交请假申请时需要选择值班表
- 审批人自动设置：系统自动查找值班表的值班长，设置为当前审批人
- 申请编号自动生成：格式为 LV + 时间戳 + 随机数
- 审批记录查询：支持查看审批历史
- 重新提交功能：被拒绝的申请可以重新提交

**功能特性**:
- 请假类型：事假、病假、年假、调休、其他
- 请假时长计算
- 开始和结束日期选择
- 开始和结束时间选择
- 请假原因填写
- 附件上传支持
- 审批记录时间线展示
- 当前审批人显示
- 时间格式化显示

**API接口**:
- `POST /duty/leave-request` - 提交请假申请
- `GET /duty/leave-request/my/{employeeId}` - 获取我的请假申请
- `GET /duty/leave-request/{id}` - 获取请假申请详情
- `DELETE /duty/leave-request/{id}` - 删除请假申请
- `GET /duty/leave-request/approval-records/{requestId}` - 获取审批记录

### 6. 请假审批功能

**实现位置**: 
- [LeaveRequestController.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/controller/LeaveRequestController.java)
- [LeaveRequestService.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/LeaveRequestService.java)
- [LeaveRequestServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/LeaveRequestServiceImpl.java)
- [LeaveApproval.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/duty/LeaveApproval.vue)

**核心逻辑**:
- 值班长审批：值班长只能看到自己作为值班长的值班表中的待审批申请
- 排班检查：检查申请人请假期间是否有排班
- 自动排班：支持轮换排班和均衡排班
- 排班完成确认：值班长确认排班完成后才能流转审批
- 审批意见记录：支持填写审批意见
- 拒绝原因记录：拒绝时必须填写拒绝原因

**功能特性**:
- 待审批列表查询：根据值班长身份查询待审批申请
- 值班表筛选：支持按值班表筛选待审批申请
- 排班处理方式：
  - 检查排班：检查申请人请假期间是否有排班
  - 自动排班：自动生成排班
    - 轮换排班：人员轮流值班
    - 均衡排班：按员工本月工时优先排少
  - 跳过：直接审批通过
- 排班完成确认：检查排班后确认排班完成
- 跳转到排班页面：点击"去排班"按钮跳转到值班安排页面
- 时间格式化显示

**API接口**:
- `GET /duty/leave-request/pending/{approverId}` - 获取待审批列表
- `GET /duty/leave-request/pending/schedule/{scheduleId}` - 根据值班表ID获取待审批列表
- `PUT /duty/leave-request/approve/{requestId}` - 审批请假申请
- `GET /duty/leave-request/check-schedule` - 检查员工排班
- `PUT /duty/leave-request/confirm-schedule/{requestId}` - 确认排班完成

### 7. 多级审批流程

**实现位置**: [LeaveRequestServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/LeaveRequestServiceImpl.java)

**核心逻辑**:
- 审批层级管理：支持多级审批
- 审批人权限验证：检查审批人是否有权限
- 审批记录：记录每次审批操作
- 审批状态流转：pending -> approved/rejected
- 审批意见记录：支持审批意见填写
- 当前审批人设置：提交请假申请时自动设置值班长为当前审批人

**API接口**:
- `PUT /duty/leave-request/approve/{requestId}` - 审批请假申请

### 8. 消息提醒功能

**实现位置**: [NotificationServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/NotificationServiceImpl.java)

**功能特性**:
- 消息发送：支持发送各种类型消息
- 消息接收：按接收人查询消息
- 未读消息：查询未读消息
- 消息已读：标记消息为已读
- 批量已读：批量标记消息为已读
- 消息删除：删除消息
- 关联信息：支持关联业务数据

**API接口**:
- `GET /duty/notification/list/{receiverId}` - 获取所有消息
- `GET /duty/notification/unread/{receiverId}` - 获取未读消息
- `PUT /duty/notification/read/{notificationId}` - 标记消息已读
- `PUT /duty/notification/read-all/{receiverId}` - 批量标记已读
- `DELETE /duty/notification/{notificationId}` - 删除消息

### 9. 报表导出功能

**实现位置**: [ExcelExportUtil.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/util/ExcelExportUtil.java)

**支持导出**:
- 值班安排导出
- 值班记录导出
- 请假申请导出

**特性**:
- 自动列宽调整
- 表头样式设置
- 中文文件名支持
- UTF-8编码

**API接口**:
- `GET /duty/export/assignments` - 导出值班安排
- `GET /duty/export/records` - 导出值班记录
- `GET /duty/export/leave-requests` - 导出请假申请

### 10. 排班统计功能

**实现位置**: [DutyStatisticsServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/DutyStatisticsServiceImpl.java)

**统计维度**:
- 总体统计：总排班数、总值班安排、总值班记录、日均时长、总加班时长、请假申请数
- 部门统计：各部门排班数量统计
- 班次分布：各班次数量占比
- 月度趋势：近6个月出勤和加班趋势

**API接口**:
- `GET /duty/statistics/overall` - 获取总体统计
- `GET /duty/statistics/dept` - 获取部门统计
- `GET /duty/statistics/shift-distribution` - 获取班次分布
- `GET /duty/statistics/monthly-trend` - 获取月度趋势
- `GET /duty/statistics` - 获取所有统计数据

### 11. 请假调班管理

**请假申请**:
- 请假类型：事假、病假、年假、调休、其他
- 请假时长计算
- 申请编号自动生成
- 值班表选择：必须选择值班表
- 审批人自动设置：自动设置为值班长
- 替补人员选择（自动/手动）
- 审批状态跟踪
- 附件上传支持

**请假审批**:
- 待审批列表查询：值班长只能看到自己作为值班长的值班表中的待审批申请
- 审批操作（通过/拒绝）
- 审批意见记录
- 审批历史查看
- 多级审批支持
- 排班检查：检查申请人请假期间是否有排班
- 自动排班：支持轮换排班和均衡排班
- 排班完成确认：值班长确认排班完成后才能流转审批

**调班管理**:
- 调班申请提交
- 调班审批流程
- 调班确认机制（原人员、目标人员确认）
- 调班历史记录

### 12. 操作日志记录

**记录内容**:
- 操作人信息
- 操作类型（登录、登出、添加、修改、删除、审批）
- 操作模块（部门、人员、用户、角色、菜单、值班）
- 操作描述
- 请求方法和URL
- 请求参数和响应结果
- IP地址和用户代理
- 执行时间
- 操作状态和错误信息

**技术优化**:
- **响应结果长度限制**：为避免数据库字段溢出错误，响应结果长度被限制为1000个字符，超过部分会被截断并添加"..."标记
- **搜索功能优化**：修复了操作日志页面搜索功能，支持按操作人、操作类型、操作模块和时间范围进行组合查询

**查询功能**:
- 按操作人查询
- 按操作类型查询
- 按操作模块查询
- 按时间范围查询
- 组合条件查询

## 📊 功能特性

### 1. 基础信息管理
- ✅ 部门树形结构
- ✅ 人员信息管理
- ✅ 用户账号管理
- ✅ 菜单权限配置
- ✅ 角色权限配置
- ✅ 班次配置管理
- ✅ 排班规则配置
- ✅ 人员可排班时段管理

### 2. 排班计划管理
- ✅ 值班表创建和管理
- ✅ 值班表搜索功能
- ✅ 值班表分页显示
- ✅ 值班人员管理（穿梭框选择）
- ✅ 值班长设置（复选框选择）
- ✅ 值班安排日历视图
- ✅ 值班安排手动调整
- ✅ 批量排班功能（轮换排班、固定排班）
- ✅ 批量清空排班（日期范围选择、二次确认）
- ✅ 值班长权限控制（前端和后端双重验证）
- ✅ 值班记录签到签退
- ✅ 自动排班算法
- ✅ 冲突检测
- ✅ 排班版本管理

### 3. 请假调班管理
- ✅ 请假申请提交（值班表选择）
- ✅ 请假审批流程（值班长权限控制）
- ✅ 当前审批人显示
- ✅ 审批记录时间线展示
- ✅ 重新提交功能
- ✅ 排班检查功能
- ✅ 自动排班功能（轮换排班、均衡排班）
- ✅ 排班完成确认功能
- ✅ 跳转到排班页面
- ✅ 替补人员匹配（自动/手动）
- ✅ 调班申请提交
- ✅ 调班审批流程
- ✅ 调班确认机制
- ✅ 时间格式化显示

### 4. 报表统计分析
- ✅ 总体统计数据
- ✅ 部门维度统计
- ✅ 班次分布统计
- ✅ 月度趋势统计
- ✅ Excel报表导出

### 5. 系统权限管理
- ✅ 角色权限配置
- ✅ 操作日志记录
- ✅ 消息提醒功能
- ✅ 数据权限隔离

## 🚀 部署指南

### 1. 数据库初始化

```bash
# 第一步：执行DDL脚本（创建所有表结构）
mysql -u root -p hyper_duty < src/main/resources/sql/hyper_duty_ddl.sql

# 第二步：执行DML脚本（插入初始数据）
mysql -u root -p hyper_duty < src/main/resources/sql/hyper_duty_dml.sql
```

### 2. 后端启动

```bash
# 编译项目
mvn clean package

# 启动应用
java -jar target/hyper-duty-*.jar
```

### 3. 前端启动

```bash
# 进入前端目录
cd frontend

# 安装依赖（首次运行）
npm install

# 启动开发服务器
npm run dev
```

### 4. 系统访问

打开浏览器访问: http://localhost:5173

默认账号：
- 超级管理员：admin / 123456
- 普通用户：zhangsan / 123456

## 📝 使用说明

### 值班表管理
1. 登录系统
2. 进入"值班管理" -> "值班表管理"
3. 查看值班表列表：
   - 支持搜索值班表名称
   - 支持分页查看
   - 显示值班表名称、描述、开始日期、结束日期、状态
4. 添加值班表：
   - 点击"添加值班表"按钮
   - 填写值班表信息：
     - 值班表名称
     - 描述
     - 开始日期
     - 结束日期
     - 状态（启用/禁用）
   - 点击"确定"保存
5. 编辑值班表：
   - 点击"编辑"按钮
   - 修改值班表信息
   - 点击"确定"保存
6. 管理值班人员：
   - 点击"人员"按钮
   - 切换到"人员列表"标签页：
     - 使用穿梭框选择值班人员
     - 左侧显示可选人员
     - 右侧显示已选人员
     - 支持搜索人员
   - 切换到"值班长设置"标签页：
     - 勾选需要设置为值班长的人员
     - 显示当前值班长数量
   - 点击"保存"按钮
7. 删除值班表：
   - 点击"删除"按钮
   - 确认删除操作

### 值班安排
1. 登录系统（需要值班长权限）
2. 进入"值班管理" -> "值班安排"
3. 选择值班表：
   - 从下拉列表中选择值班表
   - 系统自动加载该值班表的排班信息
4. 查看排班日历：
   - 日历显示每天的排班情况
   - 显示班次和值班人员
   - 空白日期显示+号按钮（仅值班长可见）
5. 手动排班：
   - 点击日历上的+号按钮（仅值班长可见）
   - 填写排班信息：
     - 值班日期
     - 班次
     - 值班人员（仅显示该值班表的人员）
     - 状态（有效/无效）
     - 备注
   - 点击"确定"保存
6. 编辑排班：
   - 点击排班记录（仅值班长可见）
   - 修改排班信息
   - 点击"确定"保存
7. 批量排班：
   - 点击"批量排班"按钮（仅值班长可见）
   - 填写批量排班信息：
     - 日期范围（开始日期和结束日期）
     - 排班方式：
       - 轮换排班：人员轮流值班
       - 固定排班：所有人员都值班
     - 班次
     - 值班人员（多选）
     - 备注
   - 点击"确定"保存
   - 系统自动生成排班记录
8. 批量清空排班：
   - 点击"批量清空"按钮（仅值班长可见）
   - 选择日期范围
   - 点击"确认清空"
   - 在确认对话框中点击"确定"
   - 系统清空指定日期范围的所有排班
9. 权限说明：
   - 只有值班长才能进行排班操作
   - 非值班长只能查看排班信息
   - 非值班长无法看到+号按钮
   - 非值班长无法编辑排班记录

### 班次配置管理
1. 登录系统
2. 进入"值班管理" -> "班次配置"
3. 点击"添加班次"按钮
4. 填写班次信息：
   - 班次名称
   - 班次编码
   - 班次类型
   - 上班时间
   - 下班时间
   - 时长
   - 休息时长
   - 是否加班班次
   - 状态
   - 备注
5. 点击"确定"保存
6. 可以编辑、启用/禁用、删除班次

### 请假申请
1. 登录系统
2. 进入"值班管理" -> "请假申请"
3. 点击"申请请假"按钮
4. 填写请假信息：
   - 值班表（必选）
   - 请假类型
   - 请假时长
   - 开始日期和时间
   - 结束日期和时间
   - 请假原因
   - 上传附件（可选）
5. 点击"提交申请"
6. 系统自动生成申请编号并设置值班长为当前审批人
7. 可以查看申请详情或撤销申请
8. 可以查看审批记录和当前审批人

### 请假审批
1. 登录系统（需要值班长权限）
2. 进入"值班管理" -> "请假审批"
3. 查看待审批的请假申请列表（只显示自己作为值班长的值班表中的申请）
4. 点击"审批"按钮
5. 查看申请详情
6. 选择审批结果（通过/拒绝）
7. 选择排班处理方式：
   - 检查排班：检查申请人请假期间是否有排班
   - 自动排班：
     - 选择排班方式（轮换排班/均衡排班）
     - 选择排班日期范围
     - 系统自动生成排班
   - 跳过：直接审批通过
8. 填写审批意见
9. 点击"确定"完成审批"
10. 如果选择检查排班：
    - 检查排班后，点击"确认排班完成"按钮完成审批
    - 或点击"去排班"按钮跳转到值班安排页面
11. 查看已审批记录：
    - 切换到"已审批"标签页
    - 查看历史审批记录
    - 支持按值班表筛选已审批记录

### 调班管理
1. 登录系统
2. 进入"值班管理" -> "调班管理"
3. 点击"申请调班"按钮
4. 填写调班信息：
   - 原值班人员
   - 目标值班人员
   - 调班日期
   - 调班班次
   - 调班原因
5. 点击"提交申请"
6. 系统自动生成申请编号
7. 可以查看申请详情或撤销申请

### 排班统计
1. 登录系统
2. 进入"值班管理" -> "排班统计"
3. 查看统计数据：
   - 总体统计（排班概览、出勤统计）
   - 部门统计
   - 班次分布（饼图）
   - 月度趋势（柱状图）
4. 可以导出Excel报表

### 操作日志查看
1. 登录系统
2. 进入"值班管理" -> "操作日志"
3. 查看所有操作日志
4. 可以按操作类型、模块、时间等筛选
5. 查看操作详情

### 自动排班
1. 登录系统
2. 进入"值班管理" -> "值班表管理"
3. 选择值班表
4. 点击"自动排班"按钮
5. 选择排班规则
6. 系统自动生成排班计划
7. 可以手动调整排班

## 🔒 权限管理

### 角色权限

| 角色 | 权限范围 |
|------|----------|
| 超级管理员（ROLE_ADMIN） | 所有权限 |
| 普通用户（ROLE_USER） | 基础操作权限 |

### 数据权限

- 员工只能查看自己的排班和请假申请
- 管理员可以查看部门或全部数据
- 审批人只能查看待审批的申请

### 值班长权限

- 值班长可以管理值班表的排班
- 值班长可以手动排班（点击日历上的+号）
- 值班长可以编辑排班记录
- 值班长可以批量排班（轮换排班、固定排班）
- 值班长可以批量清空排班（按日期范围）
- 值班长可以审批请假申请（只能审批自己作为值班长的值班表中的申请）
- 非值班长只能查看排班信息，无法进行排班操作
- 值班长权限通过前端和后端双重验证

## 📁 文件结构

### 后端文件结构

```
src/main/java/com/lasu/hyperduty/
├── entity/                    # 实体类（20个）
│   ├── SysDept.java
│   ├── SysEmployee.java
│   ├── SysUser.java
│   ├── SysMenu.java
│   ├── SysRole.java
│   ├── SysUserRole.java
│   ├── SysRoleMenu.java
│   ├── DutySchedule.java
│   ├── DutyScheduleEmployee.java
│   ├── DutyAssignment.java
│   ├── DutyRecord.java
│   ├── DutyShiftConfig.java
│   ├── DutyScheduleRule.java
│   ├── EmployeeAvailableTime.java
│   ├── LeaveRequest.java
│   ├── ApprovalRecord.java
│   ├── SwapRequest.java
│   ├── OperationLog.java
│   ├── ScheduleVersion.java
│   ├── DutyStatistics.java
│   └── Notification.java
├── mapper/                    # Mapper接口（20个）
│   ├── SysDeptMapper.java
│   ├── SysEmployeeMapper.java
│   ├── SysUserMapper.java
│   ├── SysMenuMapper.java
│   ├── SysRoleMapper.java
│   ├── SysUserRoleMapper.java
│   ├── SysRoleMenuMapper.java
│   ├── DutyScheduleMapper.java
│   ├── DutyAssignmentMapper.java
│   ├── DutyRecordMapper.java
│   ├── DutyShiftConfigMapper.java
│   ├── DutyScheduleRuleMapper.java
│   ├── EmployeeAvailableTimeMapper.java
│   ├── LeaveRequestMapper.java
│   ├── ApprovalRecordMapper.java
│   ├── SwapRequestMapper.java
│   ├── OperationLogMapper.java
│   ├── ScheduleVersionMapper.java
│   ├── DutyStatisticsMapper.java
│   └── NotificationMapper.java
├── service/                   # Service接口（20个）
│   ├── SysDeptService.java
│   ├── SysEmployeeService.java
│   ├── SysUserService.java
│   ├── SysMenuService.java
│   ├── SysRoleService.java
│   ├── SysUserRoleService.java
│   ├── SysRoleMenuService.java
│   ├── DutyScheduleService.java
│   ├── DutyAssignmentService.java
│   ├── DutyRecordService.java
│   ├── DutyShiftConfigService.java
│   ├── DutyScheduleRuleService.java
│   ├── EmployeeAvailableTimeService.java
│   ├── LeaveRequestService.java
│   ├── ApprovalRecordService.java
│   ├── SwapRequestService.java
│   ├── OperationLogService.java
│   ├── ScheduleVersionService.java
│   ├── NotificationService.java
│   ├── AutoScheduleService.java
│   └── DutyStatisticsService.java
├── service/impl/              # Service实现（23个）
│   ├── SysDeptServiceImpl.java
│   ├── SysEmployeeServiceImpl.java
│   ├── SysUserServiceImpl.java
│   ├── SysMenuServiceImpl.java
│   ├── SysRoleServiceImpl.java
│   ├── SysUserRoleServiceImpl.java
│   ├── SysRoleMenuServiceImpl.java
│   ├── DutyScheduleServiceImpl.java
│   ├── DutyAssignmentServiceImpl.java
│   ├── DutyRecordServiceImpl.java
│   ├── DutyShiftConfigServiceImpl.java
│   ├── DutyScheduleRuleServiceImpl.java
│   ├── EmployeeAvailableTimeServiceImpl.java
│   ├── LeaveRequestServiceImpl.java
│   ├── ApprovalRecordServiceImpl.java
│   ├── SwapRequestServiceImpl.java
│   ├── OperationLogServiceImpl.java
│   ├── ScheduleVersionServiceImpl.java
│   ├── NotificationServiceImpl.java
│   ├── AutoScheduleServiceImpl.java
│   ├── DutyStatisticsServiceImpl.java
│   └── ExportServiceImpl.java
├── controller/                 # Controller（17个）
│   ├── SysDeptController.java
│   ├── SysEmployeeController.java
│   ├── SysUserController.java
│   ├── SysMenuController.java
│   ├── SysRoleController.java
│   ├── DutyScheduleController.java
│   ├── DutyAssignmentController.java
│   ├── DutyRecordController.java
│   ├── DutyShiftConfigController.java
│   ├── LeaveRequestController.java
│   ├── LeaveApprovalController.java
│   ├── SwapRequestController.java
│   ├── DutyStatisticsController.java
│   ├── OperationLogController.java
│   ├── AutoScheduleController.java
│   ├── ExportController.java
│   └── NotificationController.java
├── common/                    # 公共类
│   ├── ResponseResult.java
│   └── GlobalExceptionHandler.java
└── util/                      # 工具类
    └── ExcelExportUtil.java
```

### 前端文件结构

```
frontend/src/
├── views/                     # 页面组件（10个）
│   ├── Dashboard.vue
│   ├── Dept.vue
│   ├── Employee.vue
│   ├── User.vue
│   ├── Menu.vue
│   ├── Role.vue
│   ├── duty/
│   │   ├── DutyLayout.vue
│   │   ├── DutySchedule.vue
│   │   ├── DutyAssignment.vue
│   │   ├── DutyRecord.vue
│   │   ├── ShiftConfig.vue
│   │   ├── LeaveRequest.vue
│   │   ├── LeaveApproval.vue
│   │   ├── SwapRequest.vue
│   │   ├── Statistics.vue
│   │   └── OperationLog.vue
│   └── Login.vue
├── api/                       # API封装（10个）
│   ├── dept.js
│   ├── employee.js
│   ├── user.js
│   ├── menu.js
│   ├── role.js
│   ├── duty/
│   │   ├── schedule.js
│   │   ├── assignment.js
│   │   ├── record.js
│   │   ├── shiftConfig.js
│   │   ├── leaveRequest.js
│   │   ├── leaveApproval.js
│   │   ├── swapRequest.js
│   │   ├── statistics.js
│   │   ├── operationLog.js
│   │   └── notification.js
│   └── auth.js
├── router/                    # 路由配置
│   └── index.js
├── components/                 # 公共组件
│   └── Layout.vue
├── stores/                    # 状态管理
│   └── user.js
└── utils/                     # 工具函数
    ├── request.js
    └── dateUtils.js
```

### SQL文件结构

```
src/main/resources/sql/
├── hyper_duty_ddl.sql        # DDL脚本（建表语句）
└── hyper_duty_dml.sql        # DML脚本（初始数据）
```

## 🎯 技术栈

### 后端技术栈
- **框架**: Spring Boot 3.x
- **ORM**: MyBatis Plus
- **数据库**: MySQL 8.0+
- **构建工具**: Maven
- **Java版本**: JDK 17+

### 前端技术栈
- **框架**: Vue 3
- **UI库**: Element Plus
- **构建工具**: Vite
- **HTTP客户端**: Axios
- **图表库**: ECharts
- **状态管理**: Pinia
- **日期处理**: Day.js

## 🎨 界面特点

- 响应式设计，支持多种屏幕尺寸
- Element Plus组件库，界面美观
- 表格支持分页、排序、筛选
- 表单验证，数据完整性保证
- 图表展示，数据可视化
- 操作日志记录，审计追踪
- 消息通知，及时提醒
- 日历视图展示排班信息
- 穿梭框选择值班人员
- 复选框设置值班长
- 权限控制，按钮和操作根据权限显示
- 警告提示和二次确认，防止误操作
- 时间格式化显示，提升用户体验

## 📈 性能优化

### 数据库优化
- 为常用查询字段添加索引
- 外键约束保证数据完整性
- 使用utf8mb4字符集支持中文

### 代码优化
- 使用MyBatis Plus简化CRUD操作
- Service层业务逻辑封装
- 统一异常处理
- 操作日志记录

## 🔐 安全特性

- 密码BCrypt加密存储
- JWT Token认证
- 角色权限控制
- 操作日志审计
- SQL注入防护（MyBatis Plus）
- XSS攻击防护

## 📚 相关文档

- [需求说明书.md](file:///d:/workspace/lasudev/hyper-duty/需求说明书.md)
- [开发手册.md](file:///d:/workspace/lasudev/hyper-duty/开发手册.md)

## 🎯 总结

本项目实现了一个完整的值班管理系统，包含：

### 数据库
- **20个表**：系统基础表11个 + 值班管理扩展表9个
- **DDL脚本**：建表语句（包含所有新增字段）
- **DML脚本**：初始数据

### 后端
- **20个实体类**：对应所有数据库表
- **20个Mapper接口**：数据访问层
- **23个Service**：业务逻辑层（20个基础 + 3个扩展）
- **17个Controller**：控制层
- **1个工具类**：Excel导出

### 前端
- **10个页面组件**：完整的UI界面
- **10个API封装**：前后端交互
- **路由配置**：9个值班管理子路由
- **菜单注册**：17个系统菜单
- **状态管理**：Pinia store
- **工具函数**：日期格式化、请求封装

### 核心功能
✅ 基础信息管理（8个子模块）
✅ 排班计划管理（8个子模块）
✅ 请假调班管理（6个子模块）
✅ 报表统计分析（4个子模块）
✅ 系统权限管理（3个子模块）

### 特色功能
✅ 值班长权限控制（值班长设置、权限验证）
✅ 批量排班功能（轮换排班、固定排班）
✅ 批量清空排班（日期范围选择、二次确认）
✅ 自动排班算法（负载均衡、冲突检测）
✅ 多级审批流程（权限验证、审批记录）
✅ 消息提醒功能（实时通知、已读标记）
✅ 报表导出功能（Excel导出、样式设置）
✅ 操作日志记录（审计追踪、多条件查询）
✅ 请假申请功能（值班表选择、审批人自动设置）
✅ 请假审批功能（值班长权限控制、排班检查、自动排班）
✅ 当前审批人显示（实时显示审批进度）
✅ 审批记录时间线（可视化审批流程）
✅ 时间格式化显示（统一时间格式）
✅ 排班完成确认（确保排班完成后才能流转）
✅ 均衡排班（按员工本月工时优先排少）

---

**文档版本**: 4.0  
**创建日期**: 2026-01-17  
**最后更新**: 2026-01-19
