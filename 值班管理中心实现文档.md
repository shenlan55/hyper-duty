# 值班管理中心实现文档

## 📋 项目概述

本文档记录了值班管理系统的完整实现，包括排班计划管理、请假调班管理、报表统计等核心模块。

## 🗄️ 数据库设计

### 表结构总览
  
**值班管理核心表（12个）**
1. duty_schedule - 值班表
2. duty_schedule_employee - 值班表人员关联表
3. duty_assignment - 值班安排表
4. duty_record - 值班记录表
5. duty_shift_config - 班次配置表
6. duty_schedule_rule - 排班规则配置表
7. employee_available_time - 人员可排班时段表
8. leave_request - 请假申请表
9. approval_record - 审批记录表
10. swap_request - 调班记录表
11. schedule_version - 排班版本表
12. notification - 消息通知表
13. duty_statistics - 排班统计表
14. duty_holiday - 节假日表
15. duty_shift_mutex - 班次互斥关系表

**总计：15个表**

#### 1. 值班表人员关联表 (duty_schedule_employee)
管理值班表与人员的关联关系，支持值班长设置。

**字段说明:**
- `schedule_id`: 值班表ID
- `employee_id`: 员工ID
- `is_leader`: 是否是值班长（0-否,1-是）
- `sort_order`: 排序序号

#### 2. 班次配置表 (duty_shift_config)
管理班次的基本信息，包括班次类型、上下班时间、时长等。

**字段说明:**
- `shift_name`: 班次名称
- `shift_code`: 班次编码（唯一）
- `shift_type`: 班次类型（1-早班,2-中班,3-晚班,4-全天,5-夜班）
- `start_time`: 上班时间
- `end_time`: 下班时间
- `duration_hours`: 时长（小时）
- `break_hours`: 休息时长（小时）
- `is_overtime_shift`: 是否加班班次
- `status`: 状态（0-禁用,1-启用）

#### 3. 排班规则配置表 (duty_schedule_rule)
定义排班的规则，包括周期、负载上限、替补优先级等。

**字段说明:**
- `rule_name`: 规则名称
- `rule_code`: 规则编码（唯一）
- `schedule_cycle`: 排班周期（1-按周,2-按月,3-按季度）
- `max_daily_shifts`: 每日最大班次数
- `max_weekly_hours`: 每周最大工作时长
- `max_monthly_hours`: 每月最大工作时长
- `min_rest_days`: 每月最少休息天数
- `substitute_priority_rule`: 替补优先级规则
- `conflict_detection_rule`: 冲突检测规则

#### 4. 人员可排班时段表 (employee_available_time)
记录每个员工在每周各天的可排班时间段。

**字段说明:**
- `employee_id`: 员工ID
- `day_of_week`: 星期（1-周一,2-周二...7-周日）
- `start_time`: 开始时间
- `end_time`: 结束时间
- `is_available`: 是否可用

#### 5. 请假申请表 (leave_request)
记录员工的请假申请信息。

**字段说明:**
- `request_no`: 申请编号（唯一）
- `employee_id`: 申请人ID
- `schedule_id`: 值班表ID
- `leave_type`: 请假类型（1-事假,2-病假,3-年假,4-调休,5-其他）
- `shift_config_id`: 班次配置ID（兼容旧版本）
- `shift_config_ids`: 班次配置ID列表，多个用逗号分隔（支持多班次）
- `start_date`: 开始日期
- `end_date`: 结束日期
- `start_time`: 开始时间
- `end_time`: 结束时间
- `total_hours`: 请假总时长（小时）
- `reason`: 请假原因
- `attachment_url`: 附件URL
- `approval_status`: 审批状态（pending-待审批,approved-已通过,rejected-已拒绝,cancelled-已取消）
- `current_approver_id`: 当前审批人ID
- `approval_level`: 当前审批层级
- `total_approval_levels`: 总审批层级
- `substitute_employee_id`: 替补人员ID
- `substitute_type`: 替补类型（1-自动,2-手动）
- `substitute_status`: 替补状态（pending-待确认,confirmed-已确认,rejected-已拒绝）
- `reject_reason`: 拒绝原因
- `approval_opinion`: 审批意见
- `schedule_completed`: 排班是否完成（0-未完成,1-已完成）
- `schedule_completed_time`: 排班完成时间
- `schedule_completed_by`: 排班完成人ID
- `create_time`: 创建时间
- `update_time`: 更新时间

#### 6. 审批记录表 (approval_record)
记录审批历史，支持多级审批。

**字段说明:**
- `request_id`: 申请ID
- `request_type`: 申请类型（leave-请假,swap-调班）
- `approver_id`: 审批人ID
- `approval_level`: 审批层级
- `approval_status`: 审批状态（approved-通过,rejected-拒绝）
- `approval_opinion`: 审批意见
- `approval_time`: 审批时间
- `create_time`: 创建时间

#### 7. 调班记录表 (swap_request)
记录调班申请信息。

**字段说明:**
- `request_no`: 申请编号
- `original_employee_id`: 原值班人员ID
- `target_employee_id`: 目标值班人员ID
- `original_assignment_id`: 原值班安排ID
- `target_assignment_id`: 目标值班安排ID
- `swap_date`: 调班日期
- `swap_shift`: 调班班次
- `reason`: 调班原因
- `approval_status`: 审批状态（pending-待审批,approved-已通过,rejected-已拒绝,cancelled-已取消）
- `current_approver_id`: 当前审批人ID
- `approval_level`: 当前审批层级
- `total_approval_levels`: 总审批层级
- `original_confirm_status`: 原人员确认状态
- `target_confirm_status`: 目标人员确认状态
- `reject_reason`: 拒绝原因
- `create_time`: 创建时间
- `update_time`: 更新时间



#### 9. 排班版本表 (schedule_version)
管理排班计划的版本，支持多版本对比。

**字段说明:**
- `schedule_id`: 值班表ID
- `version_name`: 版本名称
- `version_code`: 版本编码
- `start_date`: 开始日期
- `end_date`: 结束日期
- `status`: 状态（draft-草稿,published-已发布,archived-已归档）
- `is_current`: 是否当前版本
- `create_time`: 创建时间
- `update_time`: 更新时间

#### 10. 消息通知表 (notification)
记录系统消息通知，用于提醒用户。

**字段说明:**
- `receiver_id`: 接收人ID
- `receiver_name`: 接收人姓名
- `title`: 通知标题
- `content`: 通知内容
- `type`: 通知类型
- `status`: 状态（unread-未读,read-已读）
- `related_id`: 关联ID
- `related_type`: 关联类型
- `create_time`: 创建时间
- `read_time`: 阅读时间

#### 11. 排班统计表 (duty_statistics)
记录排班统计数据。

**字段说明:**
- `dept_id`: 部门ID
- `dept_name`: 部门名称
- `total_schedules`: 总排班数
- `total_assignments`: 总值班安排数
- `total_records`: 总值班记录数
- `avg_daily_hours`: 日均时长
- `total_overtime_hours`: 总加班时长
- `total_leave_requests`: 总请假申请数
- `stat_date`: 统计日期
- `create_time`: 创建时间

#### 12. 节假日表 (duty_holiday)
记录节假日信息，用于排班系统识别节假日。

**字段说明:**
- `id`: 节假日ID
- `holiday_name`: 节假日名称
- `holiday_date`: 节假日日期
- `is_workday`: 是否调休上班（0-否,1-是）
- `holiday_type`: 节假日类型（1-法定假日,2-调休,3-公司假日）
- `remark`: 备注
- `create_time`: 创建时间
- `update_time`: 更新时间

#### 13. 班次互斥关系表 (duty_shift_mutex)
记录班次之间的互斥关系，用于排班冲突检测。

**字段说明:**
- `id`: ID
- `shift_config_id`: 班次配置ID
- `mutex_shift_config_id`: 互斥班次配置ID
- `create_time`: 创建时间
- `update_time`: 更新时间

### 修改的表

#### duty_assignment 表
新增字段:
- `shift_config_id`: 班次配置ID
- `version_id`: 排班版本ID
- `is_overtime`: 是否加班

#### duty_record 表
新增字段:
- `substitute_employee_id`: 替补人员ID
- `substitute_type`: 替补类型

## 🔧 后端实现

### 实体类（Entity）- 15个

1. **DutySchedule** - 值班表实体
2. **DutyScheduleEmployee** - 值班表人员关联实体
3. **DutyAssignment** - 值班安排实体
4. **DutyRecord** - 值班记录实体
5. **DutyShiftConfig** - 班次配置实体
6. **DutyScheduleRule** - 排班规则实体
7. **EmployeeAvailableTime** - 人员可排班时段实体
8. **LeaveRequest** - 请假申请实体
9. **ApprovalRecord** - 审批记录实体
10. **SwapRequest** - 调班记录实体
11. **ScheduleVersion** - 排班版本实体
12. **Notification** - 消息通知实体
13. **DutyStatistics** - 排班统计实体
14. **DutyHoliday** - 节假日实体
15. **DutyShiftMutex** - 班次互斥关系实体

### Mapper接口 - 15个

所有实体类都对应创建了Mapper接口，继承自BaseMapper。

### Service层

#### 核心Service（15个）

1. **DutyScheduleService** - 值班表管理服务
2. **DutyScheduleEmployeeService** - 值班表人员关联服务
3. **DutyAssignmentService** - 值班安排服务
4. **DutyRecordService** - 值班记录服务
5. **DutyShiftConfigService** - 班次配置服务
6. **DutyScheduleRuleService** - 排班规则服务
7. **EmployeeAvailableTimeService** - 人员可排班时段服务
8. **LeaveRequestService** - 请假申请服务
9. **ApprovalRecordService** - 审批记录服务
10. **SwapRequestService** - 调班申请服务
11. **ScheduleVersionService** - 排班版本服务
12. **NotificationService** - 消息通知服务
13. **DutyStatisticsService** - 排班统计服务
14. **DutyHolidayService** - 节假日管理服务
15. **DutyShiftMutexService** - 班次互斥关系服务

#### 扩展Service（3个）

1. **AutoScheduleService** - 自动排班服务
   - `generateAutoSchedule()` - 生成自动排班（轮换排班）
   - `generateAutoScheduleByWorkHours()` - 生成自动排班（按工时均衡排班）
   - `checkConflict()` - 检测排班冲突
   - `getAvailableEmployees()` - 获取可用员工
   - `getEmployeeMonthlyWorkHours()` - 获取员工本月工时

2. **DutyStatisticsService** - 排班统计服务
   - `getOverallStatistics()` - 获取总体统计
   - `getDeptStatistics()` - 获取部门统计
   - `getShiftDistribution()` - 获取班次分布
   - `getMonthlyTrend()` - 获取月度趋势

3. **ExportService** - 报表导出服务
   - `exportDutyAssignments()` - 导出值班安排
   - `exportDutyRecords()` - 导出值班记录
   - `exportLeaveRequests()` - 导出请假申请

### Controller层 - 14个

1. **DutyScheduleController** - 值班表管理控制器
2. **DutyAssignmentController** - 值班安排控制器
3. **DutyRecordController** - 值班记录控制器
4. **DutyShiftConfigController** - 班次配置控制器
5. **DutyScheduleModeController** - 排班模式控制器
6. **LeaveRequestController** - 请假申请控制器
7. **LeaveApprovalController** - 请假审批控制器
8. **SwapRequestController** - 调班管理控制器
9. **DutyStatisticsController** - 排班统计控制器
10. **AutoScheduleController** - 自动排班控制器
11. **ExportController** - 报表导出控制器
12. **NotificationController** - 消息通知控制器
13. **DutyHolidayController** - 节假日管理控制器
14. **DutyShiftMutexController** - 班次互斥关系控制器

### 工具类

1. **ExcelExportUtil** - Excel导出工具类
   - `exportDutyAssignments()` - 导出值班安排
   - `exportDutyRecords()` - 导出值班记录
   - `exportLeaveRequests()` - 导出请假申请
   - 自动列宽调整
   - 样式设置

## 🎨 前端实现

### 页面组件（Vue）- 9个

**值班管理页面（9个）**
1. **DutySchedule.vue** - 值班表管理
2. **DutyAssignment.vue** - 值班安排
3. **DutyRecord.vue** - 值班记录
4. **ShiftConfig.vue** - 班次配置
5. **LeaveRequest.vue** - 请假申请
6. **LeaveApproval.vue** - 请假审批
7. **SwapRequest.vue** - 调班管理
8. **Statistics.vue** - 排班统计
9. **ScheduleMode.vue** - 排班模式管理

**其他页面（1个）**
1. **DutyLayout.vue** - 值班管理布局

### API封装（JavaScript）- 11个

1. **schedule.js** - 值班表管理API
2. **assignment.js** - 值班安排API
3. **record.js** - 值班记录API
4. **shiftConfig.js** - 班次配置API
5. **leaveRequest.js** - 请假申请API
6. **leaveApproval.js** - 请假审批API
7. **swapRequest.js** - 调班管理API
8. **statistics.js** - 排班统计API
9. **notification.js** - 消息通知API
10. **holiday.js** - 节假日管理API
11. **scheduleMode.js** - 排班模式管理API

### 路由配置

**值班管理子路由（9个）**
1. `/duty/schedule` - 值班表管理
2. `/duty/assignment` - 值班安排
3. `/duty/record` - 值班记录
4. `/duty/shift-config` - 班次配置
5. `/duty/leave-request` - 请假申请
6. `/duty/leave-approval` - 请假审批
7. `/duty/swap-request` - 调班管理
8. `/duty/statistics` - 排班统计
9. `/duty/schedule-mode` - 排班模式管理

### 菜单注册

**值班管理菜单（9个）**
1. 值班管理
2. 值班表管理
3. 值班安排
4. 值班记录
5. 班次配置
6. 请假申请
7. 请假审批
8. 调班管理
9. 排班统计
10. 排班模式管理

**菜单权限分配**
- 超级管理员（ROLE_ADMIN）：拥有所有菜单权限
- 值班长：拥有排班操作权限
- 普通用户：拥有查看权限

## 🎯 核心功能实现

### 1. 自动排班算法

**实现位置**: [AutoScheduleServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/AutoScheduleServiceImpl.java)

**核心逻辑**:
- 负载均衡：根据员工当前工作时长和班次数量进行均衡分配
- 可用性检查：检查员工的可排班时段
- 冲突检测：避免重复排班
- 规则限制：
  - 每日最大班次数限制
  - 每周最大工作时长限制
  - 每月最大工作时长限制
- 优先级排序：
  - 工作时长少的员工优先
  - 班次数量少的员工优先
  - 同部门员工优先

**API接口**:
- `POST /duty/auto-schedule/generate` - 生成自动排班（轮换排班）
- `POST /duty/auto-schedule/generate-by-work-hours` - 生成自动排班（按工时均衡排班）
- `POST /duty/auto-schedule/generate-by-mode` - 根据排班模式生成自动排班
- `GET /duty/auto-schedule/check-conflict` - 检测排班冲突
- `GET /duty/auto-schedule/available-employees` - 获取可用员工
- `GET /duty/auto-schedule/employee-monthly-work-hours` - 获取员工本月工时

### 1.1 排班模式管理

**实现位置**:
- [DutyScheduleMode.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/entity/DutyScheduleMode.java)
- [DutyScheduleModeController.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/controller/DutyScheduleModeController.java)
- [DutyScheduleModeServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/DutyScheduleModeServiceImpl.java)
- [DutyHoliday.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/entity/DutyHoliday.java)
- [ScheduleAlgorithm.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/algorithm/ScheduleAlgorithm.java)
- [FourDayRotationAlgorithm.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/algorithm/impl/FourDayRotationAlgorithm.java)
- [ThreeDayRotationAlgorithm.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/algorithm/impl/ThreeDayRotationAlgorithm.java)
- [DaytimeAllNightShiftRotationAlgorithm.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/algorithm/impl/DaytimeAllNightShiftRotationAlgorithm.java)
- [ScheduleMode.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/duty/ScheduleMode.vue)
- [ScheduleModeEdit.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/duty/components/ScheduleModeEdit.vue)

### 1.2 批量排班功能增强

**实现位置**:
- [DutyAssignment.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/duty/DutyAssignment.vue)
- [LeaveRequestService.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/LeaveRequestService.java)
- [LeaveRequestServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/LeaveRequestServiceImpl.java)

**核心功能**:
1. **日期类型选择**:
   - 支持选择工作日、休息日、节假日三种日期类型
   - 工作日：包括周一至周五，以及节假日表中标记为调休上班的日期
   - 休息日：包括周六、周日，剔除节假日表中标记为调休上班的日期
   - 节假日：包括节假日表中标记为节假日的日期

2. **请假人员过滤**:
   - 自动查询所选日期范围内的请假信息
   - **按天过滤**：只过滤掉在当天请假的人员，其他日期正常排班
   - 确保排班时不会安排请假人员在请假当天值班
   - 支持传统排班方式和排班模式的请假人员过滤

**API接口**:
- `GET /duty/leave-request/employee-leave-info` - 批量查询员工请假信息

### 2. 请假申请功能增强

**实现位置**:
- [LeaveRequest.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/entity/LeaveRequest.java)
- [LeaveRequestService.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/LeaveRequestService.java)
- [LeaveRequestServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/LeaveRequestServiceImpl.java)
- [LeaveRequest.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/duty/LeaveRequest.vue)
- [LeaveApproval.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/duty/LeaveApproval.vue)

**核心功能**:
1. **多个值班长审批**:
   - 值班表可以设置多个值班长
   - 所有值班长都可以审批请假申请
   - 谁先审批了就生效，其他值班长不需要再审批
   - 审批状态会实时更新，避免重复审批

2. **多班次选择**:
   - 请假时可以选择多个班次
   - 请假申请和请假审批页的请假详情弹出框显示选择的班次信息
   - 请假时长为所选班次时长之和

3. **互斥班次检查**:
   - 请假时，互斥班次不能同时选择
   - 选择互斥班次时会显示错误提示
   - 系统会自动禁用与已选择班次互斥的班次
   - 确保用户无法提交包含互斥班次的请假申请

**API接口**:
- `POST /duty/leave-request` - 提交请假申请（支持多班次）
- `GET /duty/leave-request/my/{employeeId}` - 获取我的请假申请
- `GET /duty/leave-request/{id}` - 获取请假申请详情
- `PUT /duty/leave-request/approve/{requestId}` - 审批请假申请（支持多个值班长）
- `GET /duty/shift-config/check-mutex` - 检查两个班次是否互斥

### 3. 角色绑定功能增强

**实现位置**:
- [Role.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/Role.vue)

**核心功能**:
- **禁用用户过滤**:
  - 角色绑定时，禁用用户（status为0）不会显示
  - 确保只有启用的用户才能绑定角色
  - 提升用户体验，减少误操作

### 4. 班次互斥关系管理

**实现位置**:
- [DutyShiftMutex.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/entity/DutyShiftMutex.java)
- [DutyShiftMutexService.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/DutyShiftMutexService.java)
- [DutyShiftMutexServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/DutyShiftMutexServiceImpl.java)
- [DutyShiftConfigController.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/controller/DutyShiftConfigController.java)

**核心功能**:
- **互斥关系管理**:
  - 支持配置班次之间的互斥关系
  - 请假时自动检查互斥班次
  - 确保用户无法选择互斥的班次

**API接口**:
- `GET /duty/shift-config/check-mutex` - 检查两个班次是否互斥

**修复记录**:
1. **问题**: 排班模式管理中人数输入字段加载失败，显示"--"而不是默认值1
   **原因**: 数据类型转换问题，count字段在解析和更新过程中没有正确保持为数字类型
   **解决方案**:
   - 在解析configJson时，确保count字段被转换为数字类型
   - 在watch监听器中，添加类型检查和转换
   - 在生成configJson时，确保count字段保持为数字类型
   - 确保新添加的班次和天数的count字段也正确初始化为数字类型

2. **问题**: 状态设置没生效，所有排班模式的状态开关都是关闭的
   **原因**: 数据类型不匹配，后端返回的status是数字类型，前端el-switch组件绑定的是字符串类型
   **解决方案**:
   - 在数据获取时，确保status字段为字符串类型：`status: item.status.toString()`
   - 在状态变更处理时，确保status为数字类型再发送到后端：`status: Number(row.status)`
   - 优化状态恢复逻辑，使用保存的原始状态进行恢复

3. **问题**: 班次下拉菜单显示数字而不是中文名称
   **原因**: 类型不匹配，shiftId与enabledShifts中的id类型不一致
   **解决方案**:
   - 将el-select组件的:value属性绑定修改为字符串类型：`:value="shiftConfig.id.toString()"`
   - 修改班次查找逻辑，使用类型无关的比较：`s.id.toString() === shift.shiftId.toString()`
   - 确保班次选择变化时，shiftName正确更新

4. **问题**: 人数设置最小值为1，无法设置0人
   **原因**: 业务需求变更，需要支持不需要排班的班次设置为0人
   **解决方案**:
   - 将人数输入最小值从1改为0：`:min="0"`
   - 更新相关默认值和数据处理逻辑
   - 添加班次和人数的对应关系验证

5. **问题**: 班次配置中选择了是否跨天，再次打开编辑对话框时不显示勾选状态
   **原因**: 后端isCrossDay字段是Integer类型(1/0)，前端el-switch组件期望布尔类型(true/false)，类型不匹配导致显示异常
   **解决方案**:
   - 在openEditDialog函数中，将后端返回的isCrossDay值(1/0)转换为布尔类型(true/false)后再赋值给表单
   - 修复文件：frontend/src/views/duty/ShiftConfig.vue

6. **问题**: 排班模式管理不按序号顺序排序
   **原因**: 未实现排序逻辑，默认按数据库插入顺序显示
   **解决方案**:
   - 在DutyScheduleModeService中添加getAllModesWithSort()方法
   - 在DutyScheduleModeServiceImpl中实现排序逻辑，使用QueryWrapper.orderByAsc("sort")
   - 在DutyScheduleModeController中使用排序方法

7. **问题**: 菜单展示不按授权走，普通用户看不到授权的值班管理菜单
   **原因**: 菜单权限查询逻辑不完善，未正确处理父菜单与子菜单的授权关系
   **解决方案**:
   - 重新设计SysMenuMapper.xml中的selectMenusByUserId查询
   - 使用EXISTS子查询检查用户是否授权了当前菜单或其子菜单
   - 确保父菜单在子菜单授权时也能显示

8. **问题**: 报错"用户不存在"，但用户实际存在
   **原因**: JwtAuthenticationFilter中放行的路径包含了/menu/，导致菜单查询接口不需要认证
   **解决方案**:
   - 修改JwtAuthenticationFilter，移除/menu/路径的放行
   - 确保所有需要认证的接口都经过JWT验证

9. **问题**: 点击系统管理菜单报错
   **原因**: 前端菜单路径构建逻辑不完善，子菜单路径没有正确添加父菜单路径前缀
   **解决方案**:
   - 在Layout.vue中修改菜单加载逻辑
   - 为子菜单的路径添加父菜单的路径前缀
   - 特殊处理系统管理和值班管理菜单的子菜单路径

10. **问题**: 用户绑定对话框显示用户ID而不是实际人名
    **原因**: 用户绑定逻辑未加载完整的用户信息
    **解决方案**:
    - 在Role.vue中修改handleUserBind函数
    - 点击"用户绑定"按钮时加载所有用户信息
    - 确保显示用户实际姓名而不是ID

11. **问题**: 循环依赖问题
    **原因**: PasswordEncoder Bean与其他Bean之间存在循环依赖
    **解决方案**:
    - 创建单独的PasswordEncoderConfig.java文件定义PasswordEncoder Bean
    - 在SysUserServiceImpl中使用方法注入打破循环依赖

12. **问题**: 安全配置不完善
   **原因**: SecurityConfig中放行的路径过多，存在安全隐患
   **解决方案**:
   - 只保留真正需要公开的路径
   - 确保所有业务接口都需要认证
   - 检查并优化所有安全相关配置

13. **问题**: 请假人员过滤有问题，只要用户请假的，所有排班日子都给他过滤掉没有排了
   **原因**: 批量排班逻辑中，只要员工在排班期间有任何请假，就会被完全过滤掉，而不是只在请假当天过滤
   **解决方案**:
   - 修改前端批量排班逻辑，为每个日期单独过滤出当天没有请假的员工
   - 修改后端generateScheduleByMode方法，处理前端传入的leaveInfo参数，按天过滤请假员工
   - 确保传统排班方式和排班模式都支持按天过滤请假人员
   - 添加错误处理和日志记录，确保系统稳定性

14. **问题**: 请假人员过滤不够精确，没有考虑值班表和班次维度
   **原因**: 批量排班逻辑中，只考虑了日期维度的请假过滤，没有考虑值班表和班次维度，导致员工在请假的值班表和班次之外的排班也被过滤掉
   **解决方案**:
   - 修改后端LeaveRequestService接口，更新getEmployeeLeaveInfo方法返回更详细的请假信息，包括值班表ID和班次配置ID列表
   - 修改LeaveRequestServiceImpl实现，处理请假记录时提取值班表ID和班次配置ID列表
   - 修改前端fetchEmployeeLeaveInfo函数和isEmployeeOnLeave函数，支持按天+班次+值班表的精确过滤
   - 修改handleBatchSave函数，在调用isEmployeeOnLeave时传递正确的值班表ID和班次ID参数
   - 修改后端AutoScheduleServiceImpl的generateScheduleByMode方法，支持按天+班次+值班表的精确过滤
   - 添加错误处理和日志记录，确保系统稳定性

15. **问题**: 排班模式生成时请假过滤逻辑无法正确执行
   **原因**: 在AutoScheduleServiceImpl中，班次类型(shiftType)是在过滤员工之后才定义的，导致请假检查时无法获取班次信息
   **解决方案**:
   - 调整代码执行顺序，将班次配置获取逻辑移到员工过滤之前
   - 确保在检查员工请假状态时，班次类型(shiftType)已经被正确定义
   - 保持其他请假过滤逻辑不变，确保按天+班次+值班表的精确过滤功能正常工作
   - 添加错误处理和日志记录，确保系统稳定性

16. **问题**: 请假审批-待审批，应该只有发起人自己和值班长能看到，但是现在其他人员也看到了
   **原因**: LeaveRequestServiceImpl中的getPendingApprovals和getPendingApprovalsPage方法缺少权限控制，查询了所有待审批的请假申请
   **解决方案**:
   - 修改getPendingApprovals方法，添加权限控制条件：当前审批人是请假申请的审批人，或者当前审批人是请假申请的发起人
   - 修改getPendingApprovalsPage方法，添加相同的权限控制逻辑
   - 修改getApprovedApprovals和getApprovedApprovalsPage方法，添加相同的权限控制逻辑，确保已审批记录也只有相关人员能看到
   - 确保权限控制逻辑在所有相关查询方法中保持一致
   - 添加错误处理和日志记录，确保系统稳定性

**核心逻辑**:
- 排班模式管理：支持新增、编辑、查看、删除排班模式
- 排班模式编排界面：横头是天，可以拓展第一天、第二天、第三天，按班组配置排班，每个班组包含一行班次选择和一行人数设置
- 班组管理：支持添加多个班组，实现多班组轮值，每个班组可以独立配置每天的班次和人数
- 班次和人数对应关系：如果设置了人数但没有选择班次，自动清空人数；如果选择了班次但没有设置人数，自动设置为1
- 算法接口设计：采用策略模式，支持灵活扩展
- 节假日处理：自动识别节假日，支持批量排班时跳过节假日
- 配置参数化：支持按模式配置不同的参数

**支持的排班模式**:
1. **四天一轮排班**
   - 规则：第一天白班，第二天夜班，第三天休息，第四天休息，周期性轮换
   - 参数：每组人数

2. **三天一轮排班**
   - 规则：第一天白班+夜班，第二天休息，第三天休息，周期性轮换
   - 参数：每组人数

3. **白班全员夜班轮值**
   - 规则：白天组内所有人都值班，晚上按指定人数轮值
   - 参数：夜班值班人数

4. **自定义排班模式**
   - 规则：用户可自由配置每天的班次和人数
   - 参数：天数、班次、人数等

**数据库表结构**:
- `duty_schedule_mode`：存储排班模式信息，包括模式名称、编码、类型、算法类名、配置参数等
- `duty_holiday`：存储节假日信息，包括节假日名称、日期、是否调休等

**API接口**:
- `POST /duty/auto-schedule/generate-by-mode` - 根据排班模式生成自动排班
- `GET /duty/schedule-mode/list` - 获取启用的排班模式列表
- `GET /duty/schedule-mode/getById` - 根据ID获取排班模式
- `POST /duty/schedule-mode` - 新增排班模式
- `PUT /duty/schedule-mode` - 更新排班模式
- `DELETE /duty/schedule-mode/{id}` - 删除排班模式
- `GET /duty/holiday/check` - 检查指定日期是否为节假日

**前端功能**:
- **排班模式管理页面**：支持列表展示、分页、新增、编辑、删除、启用/禁用等功能
- **排班模式编辑界面**：
  - 基本信息配置：支持配置名称、编码、类型、描述、排序、状态等
  - 天数管理：支持添加/删除天数，可拓展第一天、第二天、第三天等
  - 班组管理：支持添加/删除班组，每个班组包含一行班次选择和一行人数设置
  - 班次选择：从启用的班次配置中选择班次，显示中文名称
  - 人数设置：为每个班次设置人数，支持0人（表示休息）
  - 班次和人数对应关系：自动验证和调整班次与人数的对应关系
- **批量排班功能**：支持从下拉菜单选择排班模式进行批量排班
  - **实现原理**：
    1. 解析排班模式配置，获取周期天数、组别和班次信息
    2. 根据员工数量进行分组
    3. 按照排班模式的周期进行循环排班
    4. 确保每个班次的人数正确，不超过实际可用员工数
  - **使用方式**：
    1. 选择日期范围
    2. 选择"排班模式"选项
    3. 从下拉菜单选择预设的排班模式
    4. 选择参与排班的员工
    5. 点击"确定"生成排班

**配置参数JSON结构**:
```json
{
  "teams": [
    {
      "shifts": [
        {
          "shiftId": "1",
          "shiftName": "早班",
          "count": 2
        },
        {
          "shiftId": "2",
          "shiftName": "晚班",
          "count": 1
        },
        {
          "shiftId": "3",
          "shiftName": "夜班",
          "count": 1
        }
      ]
    },
    {
      "shifts": [
        {
          "shiftId": "2",
          "shiftName": "晚班",
          "count": 1
        },
        {
          "shiftId": "3",
          "shiftName": "夜班",
          "count": 1
        },
        {
          "shiftId": "1",
          "shiftName": "早班",
          "count": 2
        }
      ]
    }
  ],
  "days": [
    {
      "dayIndex": 1,
      "name": "第一天",
      "shifts": []
    },
    {
      "dayIndex": 2,
      "name": "第二天",
      "shifts": []
    },
    {
      "dayIndex": 3,
      "name": "第三天",
      "shifts": []
    }
  ]
}
```

**字段说明**:
- `teams`: 班组配置数组，每个对象代表一个班组
  - `shifts`: 该班组对应每天的班次配置数组
    - `shiftId`: 班次ID（字符串类型）
    - `shiftName`: 班次名称（中文）
    - `count`: 人数（数字类型，0表示休息）
- `days`: 天数配置数组，每个对象代表一天
  - `dayIndex`: 天索引
  - `name`: 天名称
  - `shifts`: 保留字段，现在从teams中获取班次配置

### 2. 冲突检测逻辑

**实现位置**: [AutoScheduleServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/AutoScheduleServiceImpl.java)

**检测类型**:
- 重复排班检测：同一员工同一天同一班次重复排班
- 超负载检测：超过每日最大班次数
- 超时长检测：超过每周/每月最大工作时长
- 可用性检测：不在可排班时段内

### 3. 值班长权限控制

**实现位置**:
- [DutyScheduleController.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/controller/DutyScheduleController.java)
- [DutyAssignment.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/duty/DutyAssignment.vue)

**核心逻辑**:
- 值班长设置：值班表可以设置多个值班长
- 权限验证：只有值班长才能进行排班操作
- 前端控制：根据当前用户是否是值班长，控制按钮和操作的显示
- 后端验证：登录接口返回 employeeId，用于权限判断

**功能特性**:
- 值班长设置：支持为值班表设置多个值班长
- 批量排班：只有值班长才能使用批量排班功能
- 手动排班：只有值班长才能点击日历上的+号进行排班
- 编辑排班：只有值班长才能编辑排班记录

### 4. 节假日集成到值班安排日历

**实现位置**:
- [DutyHolidayController.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/controller/DutyHolidayController.java)
- [holiday.js](file:///d:/workspace/lasudev/hyper-duty/frontend/src/api/duty/holiday.js)
- [DutyAssignment.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/duty/DutyAssignment.vue)

**核心逻辑**:
- 节假日API：提供获取指定日期范围内节假日信息的接口
- 日历集成：在值班安排日历中显示节假日信息
- 动态更新：当切换月份时，自动获取对应月份的节假日信息
- 视觉区分：通过不同的背景色区分普通节假日和调休工作日

**功能特性**:
- 节假日显示：在日历中显示节假日名称
- 调休识别：区分普通节假日和调休工作日
- 颜色编码：使用红色背景表示普通节假日，绿色背景表示调休工作日
- 无感知集成：节假日获取失败不影响主功能，确保系统稳定性
- 批量清空：只有值班长才能批量清空日期范围的排班

**API接口**:
- `GET /duty/schedule/{id}/employees` - 获取值班人员列表
- `GET /duty/schedule/{id}/leaders` - 获取值班长列表
- `PUT /duty/schedule/{id}/employees` - 更新值班人员
- `PUT /duty/schedule/{id}/leaders` - 更新值班长
- `PUT /duty/schedule/{id}/employees-and-leaders` - 同时更新值班人员和值班长
- `GET /duty/assignment/list/{scheduleId}` - 根据值班表ID获取值班安排
- `POST /duty/assignment/batch` - 批量添加值班安排
- `DELETE /duty/assignment/batch-delete` - 批量删除排班

### 4. 批量清空排班功能

**实现位置**: 
- [DutyAssignmentController.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/controller/DutyAssignmentController.java)
- [DutyAssignmentService.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/DutyAssignmentService.java)
- [DutyAssignment.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/duty/DutyAssignment.vue)

**核心逻辑**:
- 日期范围选择：支持选择开始日期和结束日期
- 二次确认：点击确认前弹出确认对话框
- 批量删除：根据值班表ID和日期范围删除所有排班
- 权限控制：只有值班长才能使用批量清空功能

**功能特性**:
- 日期范围选择器
- 警告提示：清空操作不可恢复
- 二次确认：防止误操作
- 操作反馈：清空成功后显示成功消息

**API接口**:
- `DELETE /duty/assignment/batch-delete` - 批量删除排班

### 5. 请假申请功能

**实现位置**: 
- [LeaveRequestController.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/controller/LeaveRequestController.java)
- [LeaveRequestService.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/LeaveRequestService.java)
- [LeaveRequestServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/LeaveRequestServiceImpl.java)
- [LeaveRequest.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/duty/LeaveRequest.vue)

**核心逻辑**:
- 值班表选择：用户提交请假申请时需要选择值班表
- 审批人自动设置：系统自动查找值班表的值班长，设置为当前审批人
- 申请编号自动生成：格式为 LV + 时间戳 + 随机数
- 审批记录查询：支持查看审批历史
- 重新提交功能：被拒绝的申请可以重新提交

**功能特性**:
- 请假类型：事假、病假、年假、调休、其他
- 请假时长计算
- 开始和结束日期选择
- 开始和结束时间选择
- 请假原因填写
- 附件上传支持
- 审批记录时间线展示
- 当前审批人显示
- 时间格式化显示

**API接口**:
- `POST /duty/leave-request` - 提交请假申请
- `GET /duty/leave-request/my/{employeeId}` - 获取我的请假申请
- `GET /duty/leave-request/{id}` - 获取请假申请详情
- `DELETE /duty/leave-request/{id}` - 删除请假申请
- `GET /duty/leave-request/approval-records/{requestId}` - 获取审批记录

### 6. 请假审批功能

**实现位置**: 
- [LeaveRequestController.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/controller/LeaveRequestController.java)
- [LeaveRequestService.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/LeaveRequestService.java)
- [LeaveRequestServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/LeaveRequestServiceImpl.java)
- [LeaveApproval.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/duty/LeaveApproval.vue)

### 7. 调班管理功能增强

**实现位置**: 
- [SwapRequestController.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/controller/SwapRequestController.java)
- [SwapRequestService.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/SwapRequestService.java)
- [SwapRequestServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/SwapRequestServiceImpl.java)
- [SwapRequest.vue](file:///d:/workspace/lasudev/hyper-duty/frontend/src/views/duty/SwapRequest.vue)

**核心功能**:
1. **分页功能**:
   - 支持页面大小调整（10、20、50、100）
   - 支持页码跳转
   - 显示总记录数

2. **筛选功能**:
   - 支持按审批状态筛选（待审批、已通过、已拒绝、已取消）
   - 支持按申请时间范围筛选

3. **下拉框宽度调整**:
   - 调整审批状态下拉框宽度为150px，确保文字完全显示

**API接口**:
- `GET /duty/swap-request/my/page/{employeeId}` - 获取我的调班申请（分页）
- `GET /duty/swap-request/pending/page/{approverId}` - 获取待审批调班申请（分页）

### 6. 请假审批功能（续）

**核心逻辑**:
- 值班长审批：值班长只能看到自己作为值班长的值班表中的待审批申请
- 排班检查：检查申请人请假期间是否有排班
- 自动排班：支持轮换排班和均衡排班
- 排班完成确认：值班长确认排班完成后才能流转审批
- 审批意见记录：支持填写审批意见
- 拒绝原因记录：拒绝时必须填写拒绝原因

**功能特性**:
- 待审批列表查询：根据值班长身份查询待审批申请
- 值班表筛选：支持按值班表筛选待审批申请
- 排班处理方式：
  - 检查排班：检查申请人请假期间是否有排班
  - 自动排班：自动生成排班
    - 轮换排班：人员轮流值班
    - 均衡排班：按员工本月工时优先排少
  - 跳过：直接审批通过
- 排班完成确认：检查排班后确认排班完成
- 跳转到排班页面：点击"去排班"按钮跳转到值班安排页面
- 时间格式化显示

**API接口**:
- `GET /duty/leave-request/pending/{approverId}` - 获取待审批列表
- `GET /duty/leave-request/pending/schedule/{scheduleId}` - 根据值班表ID获取待审批列表
- `PUT /duty/leave-request/approve/{requestId}` - 审批请假申请
- `GET /duty/leave-request/check-schedule` - 检查员工排班
- `PUT /duty/leave-request/confirm-schedule/{requestId}` - 确认排班完成

### 7. 多级审批流程

**实现位置**: [LeaveRequestServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/LeaveRequestServiceImpl.java)

**核心逻辑**:
- 审批层级管理：支持多级审批
- 审批人权限验证：检查审批人是否有权限
- 审批记录：记录每次审批操作
- 审批状态流转：pending -> approved/rejected
- 审批意见记录：支持审批意见填写
- 当前审批人设置：提交请假申请时自动设置值班长为当前审批人

**API接口**:
- `PUT /duty/leave-request/approve/{requestId}` - 审批请假申请

### 8. 消息提醒功能

**实现位置**: [NotificationServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/NotificationServiceImpl.java)

**功能特性**:
- 消息发送：支持发送各种类型消息
- 消息接收：按接收人查询消息
- 未读消息：查询未读消息
- 消息已读：标记消息为已读
- 批量已读：批量标记消息为已读
- 消息删除：删除消息
- 关联信息：支持关联业务数据

**API接口**:
- `GET /duty/notification/list/{receiverId}` - 获取所有消息
- `GET /duty/notification/unread/{receiverId}` - 获取未读消息
- `PUT /duty/notification/read/{notificationId}` - 标记消息已读
- `PUT /duty/notification/read-all/{receiverId}` - 批量标记已读
- `DELETE /duty/notification/{notificationId}` - 删除消息

### 9. 报表导出功能

**实现位置**: [ExcelExportUtil.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/util/ExcelExportUtil.java)

**支持导出**:
- 值班安排导出
- 值班记录导出
- 请假申请导出

**特性**:
- 自动列宽调整
- 表头样式设置
- 中文文件名支持
- UTF-8编码

**API接口**:
- `GET /duty/export/assignments` - 导出值班安排
- `GET /duty/export/records` - 导出值班记录
- `GET /duty/export/leave-requests` - 导出请假申请

### 10. 排班统计功能

**实现位置**: [DutyStatisticsServiceImpl.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/DutyStatisticsServiceImpl.java)

**统计维度**:
- 总体统计：总排班数、总值班安排、总值班记录、日均时长、总加班时长、请假申请数
- 部门统计：各部门排班数量统计
- 班次分布：各班次数量占比
- 月度趋势：近6个月出勤和加班趋势

**API接口**:
- `GET /duty/statistics/overall` - 获取总体统计
- `GET /duty/statistics/dept` - 获取部门统计
- `GET /duty/statistics/shift-distribution` - 获取班次分布
- `GET /duty/statistics/monthly-trend` - 获取月度趋势
- `GET /duty/statistics` - 获取所有统计数据

### 11. 请假调班管理

**请假申请**:
- 请假类型：事假、病假、年假、调休、其他
- 请假时长计算
- 申请编号自动生成
- 值班表选择：必须选择值班表
- 审批人自动设置：自动设置为值班长
- 替补人员选择（自动/手动）
- 审批状态跟踪
- 附件上传支持

**请假审批**:
- 待审批列表查询：值班长只能看到自己作为值班长的值班表中的待审批申请
- 审批操作（通过/拒绝）
- 审批意见记录
- 审批历史查看
- 多级审批支持
- 排班检查：检查申请人请假期间是否有排班
- 自动排班：支持轮换排班和均衡排班
- 排班完成确认：值班长确认排班完成后才能流转审批

**调班管理**:
- 调班申请提交
- 调班审批流程
- 调班确认机制（原人员、目标人员确认）
- 调班历史记录

### 12. 节假日信息获取

**实现位置**:
- [HolidayUtil.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/util/HolidayUtil.java)
- [HolidayTaskExecutor.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/impl/HolidayTaskExecutor.java)
- [DutyHolidayService.java](file:///d:/workspace/lasudev/hyper-duty/src/main/java/com/lasu/hyperduty/service/DutyHolidayService.java)

**核心逻辑**:
- API集成：支持从外部API获取节假日数据
- 默认数据：当API调用失败时使用默认节假日数据
- 数据存储：将节假日信息存储到数据库中，供值班系统使用

**功能特性**:
- 数据完整性：包含当前年份和下一年的节假日数据
- 容错处理：API调用失败时使用默认数据
- 日历集成：节假日信息显示在值班安排日历中

**API接口**:
- `GET /duty/holiday/list` - 获取节假日列表
- `GET /duty/holiday/check` - 检查指定日期是否为节假日
- `POST /duty/holiday/import` - 导入节假日数据

## 📊 功能特性

### 1. 排班计划管理
- ✅ 值班表创建和管理
- ✅ 值班表搜索功能
- ✅ 值班表分页显示
- ✅ 值班人员管理（穿梭框选择）
- ✅ 值班长设置（复选框选择）
- ✅ 值班安排日历视图
- ✅ 值班安排手动调整
- ✅ 批量排班功能（轮换排班、固定排班、排班模式）
- ✅ 批量排班日期类型选择（工作日、休息日、节假日）
- ✅ 批量排班请假人员过滤
- ✅ 批量清空排班（日期范围选择、二次确认）
- ✅ 值班长权限控制（前端和后端双重验证）
- ✅ 值班记录签到签退
- ✅ 自动排班算法
- ✅ 冲突检测
- ✅ 排班版本管理
- ✅ 排班模式管理

### 2. 基础信息管理
- ✅ 班次配置管理
- ✅ 排班规则配置
- ✅ 人员可排班时段管理

### 3. 请假调班管理
- ✅ 请假申请提交（值班表选择）
- ✅ 请假审批流程（值班长权限控制）
- ✅ 多个值班长审批（谁先审批谁生效）
- ✅ 当前审批人显示
- ✅ 审批记录时间线展示
- ✅ 重新提交功能
- ✅ 排班检查功能
- ✅ 自动排班功能（轮换排班、均衡排班）
- ✅ 排班完成确认功能
- ✅ 跳转到排班页面
- ✅ 替补人员匹配（自动/手动）
- ✅ 多班次选择（请假时可选择多个班次）
- ✅ 互斥班次检查（防止选择互斥班次）
- ✅ 调班申请提交
- ✅ 调班审批流程
- ✅ 调班确认机制
- ✅ 时间格式化显示

### 4. 报表统计分析
- ✅ 总体统计数据
- ✅ 部门维度统计
- ✅ 班次分布统计
- ✅ 月度趋势统计
- ✅ Excel报表导出



## 🚀 部署指南

### 1. 数据库初始化

```bash
# 第一步：执行DDL脚本（创建所有表结构）
mysql -u root -p hyper_duty < src/main/resources/sql/hyper_duty_ddl.sql

# 第二步：执行DML脚本（插入初始数据）
mysql -u root -p hyper_duty < src/main/resources/sql/hyper_duty_dml.sql
```

### 2. 后端启动

```bash
# 编译项目
mvn clean package

# 启动应用
java -jar target/hyper-duty-*.jar
```

### 3. 前端启动

```bash
# 进入前端目录
cd frontend

# 安装依赖（首次运行）
npm install

# 启动开发服务器
npm run dev
```

### 4. 系统访问

打开浏览器访问: http://localhost:5173

默认账号：
- 超级管理员：admin / 123456
- 普通用户：zhangsan / 123456

## 📝 使用说明

### 值班表管理
1. 登录系统
2. 进入"值班管理" -> "值班表管理"
3. 查看值班表列表：
   - 支持搜索值班表名称
   - 支持分页查看
   - 显示值班表名称、描述、开始日期、结束日期、状态
4. 添加值班表：
   - 点击"添加值班表"按钮
   - 填写值班表信息：
     - 值班表名称
     - 描述
     - 开始日期
     - 结束日期
     - 状态（启用/禁用）
   - 点击"确定"保存
5. 编辑值班表：
   - 点击"编辑"按钮
   - 修改值班表信息
   - 点击"确定"保存
6. 管理值班人员：
   - 点击"人员"按钮
   - 切换到"人员列表"标签页：
     - 使用穿梭框选择值班人员
     - 左侧显示可选人员
     - 右侧显示已选人员
     - 支持搜索人员
   - 切换到"值班长设置"标签页：
     - 勾选需要设置为值班长的人员
     - 显示当前值班长数量
   - 点击"保存"按钮
7. 删除值班表：
   - 点击"删除"按钮
   - 确认删除操作

### 值班安排
1. 登录系统（需要值班长权限）
2. 进入"值班管理" -> "值班安排"
3. 选择值班表：
   - 从下拉列表中选择值班表
   - 系统自动加载该值班表的排班信息
4. 查看排班日历：
   - 日历显示每天的排班情况
   - 显示班次和值班人员
   - 空白日期显示+号按钮（仅值班长可见）
   - 美化的滚动条样式，提供更好的视觉体验
5. 查看当天值班详情：
   - 点击日历上的任意日期
   - 系统弹出当天值班人员详情弹窗
   - 弹窗包含"值班详情"和"统计信息"两个标签页
   - "值班详情"标签页显示当天所有值班人员的详细信息，包括班次、人员、状态和备注
   - "统计信息"标签页显示当天的统计数据，包括总值班人数、有效值班人数、无效值班人数和节假日信息
6. 手动排班：
   - 点击日历上的+号按钮（仅值班长可见）
   - 填写排班信息：
     - 值班日期
     - 班次
     - 值班人员（仅显示该值班表的人员）
     - 状态（有效/无效）
     - 备注
   - 点击"确定"保存
7. 编辑排班：
   - 点击排班记录（仅值班长可见）
   - 修改排班信息
   - 点击"确定"保存
8. 批量排班：
   - 点击"批量排班"按钮（仅值班长可见）
   - 填写批量排班信息：
     - 日期范围（开始日期和结束日期）
     - 排班方式：
       - 轮换排班：人员轮流值班
       - 固定排班：所有人员都值班
       - 排班模式：从下拉菜单选择预设的排班模式
     - 日期类型：
       - 工作日（包括调休）：选择工作日和节假日调休的日期
       - 休息日（周末）：选择周末且不是调休的日期
       - 节假日：选择法定节假日且不是调休的日期
     - 班次
     - 值班人员（多选）
     - 备注
   - 点击"确定"保存
   - 系统自动过滤请假人员并生成排班记录
9. 批量清空排班：
   - 点击"批量清空"按钮（仅值班长可见）
   - 选择日期范围
   - 点击"确认清空"
   - 在确认对话框中点击"确定"
   - 系统清空指定日期范围的所有排班
10. 权限说明：
    - 只有值班长才能进行排班操作
    - 非值班长只能查看排班信息
    - 非值班长无法看到+号按钮
    - 非值班长无法编辑排班记录

### 班次配置管理
1. 登录系统
2. 进入"值班管理" -> "班次配置"
3. 点击"添加班次"按钮
4. 填写班次信息：
   - 班次名称
   - 班次编码
   - 班次类型
   - 上班时间
   - 下班时间
   - 时长
   - 休息时长
   - 是否加班班次
   - 状态
   - 备注
5. 点击"确定"保存
6. 可以编辑、启用/禁用、删除班次

### 请假申请
1. 登录系统
2. 进入"值班管理" -> "请假申请"
3. 点击"申请请假"按钮
4. 填写请假信息：
   - 值班表（必选）
   - 请假类型
   - 请假时长
   - 开始日期和时间
   - 结束日期和时间
   - 请假原因
   - 上传附件（可选）
5. 点击"提交申请"
6. 系统自动生成申请编号并设置值班长为当前审批人
7. 可以查看申请详情或撤销申请
8. 可以查看审批记录和当前审批人

### 请假审批
1. 登录系统（需要值班长权限）
2. 进入"值班管理" -> "请假审批"
3. 查看待审批的请假申请列表（只显示自己作为值班长的值班表中的申请）
4. 点击"审批"按钮
5. 查看申请详情
6. 选择审批结果（通过/拒绝）
7. 选择排班处理方式：
   - 检查排班：检查申请人请假期间是否有排班
   - 自动排班：
     - 选择排班方式（轮换排班/均衡排班）
     - 选择排班日期范围
     - 系统自动生成排班
   - 跳过：直接审批通过
8. 填写审批意见
9. 点击"确定"完成审批"
10. 如果选择检查排班：
    - 检查排班后，点击"确认排班完成"按钮完成审批
    - 或点击"去排班"按钮跳转到值班安排页面
11. 查看已审批记录：
    - 切换到"已审批"标签页
    - 查看历史审批记录
    - 支持按值班表筛选已审批记录

### 调班管理
1. 登录系统
2. 进入"值班管理" -> "调班管理"
3. 点击"申请调班"按钮
4. 填写调班信息：
   - 原值班人员
   - 目标值班人员
   - 调班日期
   - 调班班次
   - 调班原因
5. 点击"提交申请"
6. 系统自动生成申请编号
7. 可以查看申请详情或撤销申请

### 排班统计
1. 登录系统
2. 进入"值班管理" -> "排班统计"
3. 查看统计数据：
   - 总体统计（排班概览、出勤统计）
   - 部门统计
   - 班次分布（饼图）
   - 月度趋势（柱状图）
4. 可以导出Excel报表

### 自动排班
1. 登录系统
2. 进入"值班管理" -> "值班表管理"
3. 选择值班表
4. 点击"自动排班"按钮
5. 选择排班规则
6. 系统自动生成排班计划
7. 可以手动调整排班

## 📁 文件结构

### 后端文件结构

```
src/main/java/com/lasu/hyperduty/
├── entity/                    # 实体类（13个）
│   ├── DutySchedule.java
│   ├── DutyScheduleEmployee.java
│   ├── DutyAssignment.java
│   ├── DutyRecord.java
│   ├── DutyShiftConfig.java
│   ├── DutyScheduleRule.java
│   ├── EmployeeAvailableTime.java
│   ├── LeaveRequest.java
│   ├── ApprovalRecord.java
│   ├── SwapRequest.java
│   ├── ScheduleVersion.java
│   ├── DutyStatistics.java
│   └── Notification.java
├── mapper/                    # Mapper接口（13个）
│   ├── DutyScheduleMapper.java
│   ├── DutyAssignmentMapper.java
│   ├── DutyRecordMapper.java
│   ├── DutyShiftConfigMapper.java
│   ├── DutyScheduleRuleMapper.java
│   ├── EmployeeAvailableTimeMapper.java
│   ├── LeaveRequestMapper.java
│   ├── ApprovalRecordMapper.java
│   ├── SwapRequestMapper.java
│   ├── ScheduleVersionMapper.java
│   ├── DutyStatisticsMapper.java
│   └── NotificationMapper.java
├── service/                   # Service接口（13个）
│   ├── DutyScheduleService.java
│   ├── DutyAssignmentService.java
│   ├── DutyRecordService.java
│   ├── DutyShiftConfigService.java
│   ├── DutyScheduleRuleService.java
│   ├── EmployeeAvailableTimeService.java
│   ├── LeaveRequestService.java
│   ├── ApprovalRecordService.java
│   ├── SwapRequestService.java
│   ├── ScheduleVersionService.java
│   ├── NotificationService.java
│   ├── AutoScheduleService.java
│   └── DutyStatisticsService.java
├── service/impl/              # Service实现（16个）
│   ├── DutyScheduleServiceImpl.java
│   ├── DutyAssignmentServiceImpl.java
│   ├── DutyRecordServiceImpl.java
│   ├── DutyShiftConfigServiceImpl.java
│   ├── DutyScheduleRuleServiceImpl.java
│   ├── EmployeeAvailableTimeServiceImpl.java
│   ├── LeaveRequestServiceImpl.java
│   ├── ApprovalRecordServiceImpl.java
│   ├── SwapRequestServiceImpl.java
│   ├── ScheduleVersionServiceImpl.java
│   ├── NotificationServiceImpl.java
│   ├── AutoScheduleServiceImpl.java
│   ├── DutyStatisticsServiceImpl.java
│   └── ExportServiceImpl.java
├── controller/                 # Controller（12个）
│   ├── DutyScheduleController.java
│   ├── DutyAssignmentController.java
│   ├── DutyRecordController.java
│   ├── DutyShiftConfigController.java
│   ├── LeaveRequestController.java
│   ├── LeaveApprovalController.java
│   ├── SwapRequestController.java
│   ├── DutyStatisticsController.java
│   ├── AutoScheduleController.java
│   ├── ExportController.java
│   └── NotificationController.java
├── common/                    # 公共类
│   ├── ResponseResult.java
│   └── GlobalExceptionHandler.java
└── util/                      # 工具类
    └── ExcelExportUtil.java
```

### 前端文件结构

```
frontend/src/
├── views/                     # 页面组件（9个）
│   ├── duty/
│   │   ├── DutyLayout.vue
│   │   ├── DutySchedule.vue
│   │   ├── DutyAssignment.vue
│   │   ├── DutyRecord.vue
│   │   ├── ShiftConfig.vue
│   │   ├── LeaveRequest.vue
│   │   ├── LeaveApproval.vue
│   │   ├── SwapRequest.vue
│   │   ├── Statistics.vue
│   └── Login.vue
├── api/                       # API封装（9个）
│   ├── duty/
│   │   ├── schedule.js
│   │   ├── assignment.js
│   │   ├── record.js
│   │   ├── shiftConfig.js
│   │   ├── leaveRequest.js
│   │   ├── leaveApproval.js
│   │   ├── swapRequest.js
│   │   ├── statistics.js
│   │   └── notification.js
│   └── auth.js
├── router/                    # 路由配置
│   └── index.js
├── components/                 # 公共组件
│   └── Layout.vue
├── stores/                    # 状态管理
│   └── user.js
└── utils/                     # 工具函数
    ├── request.js
    └── dateUtils.js
```

### SQL文件结构

```
src/main/resources/sql/
├── hyper_duty_ddl.sql        # DDL脚本（建表语句）
└── hyper_duty_dml.sql        # DML脚本（初始数据）
```

## 🎯 技术栈

### 后端技术栈
- **框架**: Spring Boot 3.x
- **ORM**: MyBatis Plus
- **数据库**: MySQL 8.0+
- **构建工具**: Maven
- **Java版本**: JDK 17+

### 前端技术栈
- **框架**: Vue 3
- **UI库**: Element Plus
- **构建工具**: Vite
- **HTTP客户端**: Axios
- **图表库**: ECharts
- **状态管理**: Pinia
- **日期处理**: Day.js

## 🎨 界面特点

- 响应式设计，支持多种屏幕尺寸
- Element Plus组件库，界面美观
- 表格支持分页、排序、筛选
- 表单验证，数据完整性保证
- 图表展示，数据可视化
- 消息通知，及时提醒
- 日历视图展示排班信息
- 穿梭框选择值班人员
- 复选框设置值班长
- 警告提示和二次确认，防止误操作
- 时间格式化显示，提升用户体验

## 📈 性能优化

### 数据库优化
- 为常用查询字段添加索引
- 外键约束保证数据完整性
- 使用utf8mb4字符集支持中文

### 代码优化
- 使用MyBatis Plus简化CRUD操作
- Service层业务逻辑封装
- 统一异常处理

## 🔐 安全特性

- 密码BCrypt加密存储
- JWT Token认证
- SQL注入防护（MyBatis Plus）
- XSS攻击防护

## 📚 相关文档

- [需求说明书.md](file:///d:/workspace/lasudev/hyper-duty/需求说明书.md)
- [开发手册.md](file:///d:/workspace/lasudev/hyper-duty/开发手册.md)

## 🎯 总结

本项目实现了一个完整的值班管理系统，包含：

### 数据库
- **20个表**：系统基础表11个 + 值班管理扩展表9个
- **DDL脚本**：建表语句（包含所有新增字段）
- **DML脚本**：初始数据

### 后端
- **20个实体类**：对应所有数据库表
- **20个Mapper接口**：数据访问层
- **23个Service**：业务逻辑层（20个基础 + 3个扩展）
- **17个Controller**：控制层
- **1个工具类**：Excel导出

### 前端
- **10个页面组件**：完整的UI界面
- **10个API封装**：前后端交互
- **路由配置**：9个值班管理子路由
- **菜单注册**：17个系统菜单
- **状态管理**：Pinia store
- **工具函数**：日期格式化、请求封装

### 核心功能
✅ 基础信息管理（8个子模块）
✅ 排班计划管理（8个子模块）
✅ 请假调班管理（6个子模块）
✅ 报表统计分析（4个子模块）

### 特色功能
✅ 值班长权限控制（值班长设置、权限验证）
✅ 批量排班功能（轮换排班、固定排班、排班模式）
✅ 批量清空排班（日期范围选择、二次确认）
✅ 自动排班算法（负载均衡、冲突检测）
✅ 多级审批流程（审批记录）
✅ 消息提醒功能（实时通知、已读标记）
✅ 报表导出功能（Excel导出、样式设置）
✅ 请假申请功能（值班表选择、审批人自动设置）
✅ 请假审批功能（值班长权限控制、排班检查、自动排班）
✅ 当前审批人显示（实时显示审批进度）
✅ 审批记录时间线（可视化审批流程）
✅ 时间格式化显示（统一时间格式）
✅ 排班完成确认（确保排班完成后才能流转）
✅ 均衡排班（按员工本月工时优先排少）

---

**文档版本**: 4.1  
**创建日期**: 2026-01-17  
**最后更新**: 2026-01-26
