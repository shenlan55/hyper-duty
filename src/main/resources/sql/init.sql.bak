-- 设置字符集
SET NAMES utf8;
SET CHARACTER SET utf8;
SET CHARACTER_SET_DATABASE=utf8;
SET CHARACTER_SET_SERVER=utf8;

-- 创建数据库
CREATE DATABASE IF NOT EXISTS hyper_duty DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;

USE hyper_duty;

-- 删除现有表
DROP TABLE IF EXISTS sys_role_menu;
DROP TABLE IF EXISTS sys_user_role;
DROP TABLE IF EXISTS sys_menu;
DROP TABLE IF EXISTS sys_role;
DROP TABLE IF EXISTS sys_user;
DROP TABLE IF EXISTS sys_employee;
DROP TABLE IF EXISTS sys_dept;

-- 部门表
CREATE TABLE IF NOT EXISTS sys_dept (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '部门ID',
    dept_name VARCHAR(50) NOT NULL COMMENT '部门名称',
    parent_id BIGINT DEFAULT 0 COMMENT '上级部门ID',
    dept_code VARCHAR(20) NOT NULL COMMENT '部门编码',
    sort INT DEFAULT 0 COMMENT '排序',
    status TINYINT DEFAULT 1 COMMENT '状态：0禁用，1启用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_dept_code (dept_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='部门表';

-- 人员表
CREATE TABLE IF NOT EXISTS sys_employee (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '人员ID',
    employee_name VARCHAR(50) NOT NULL COMMENT '人员姓名',
    dept_id BIGINT NOT NULL COMMENT '所属部门ID',
    employee_code VARCHAR(20) COMMENT '人员编码',
    phone VARCHAR(11) COMMENT '手机号码',
    email VARCHAR(50) COMMENT '邮箱',
    gender TINYINT DEFAULT 0 COMMENT '性别：0未知，1男，2女',
    status TINYINT DEFAULT 1 COMMENT '状态：0禁用，1启用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_employee_code (employee_code),
    INDEX idx_employee_code (employee_code),
    FOREIGN KEY (dept_id) REFERENCES sys_dept(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='人员表';

-- 用户表
CREATE TABLE IF NOT EXISTS sys_user (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '用户ID',
    username VARCHAR(50) NOT NULL COMMENT '用户名',
    password VARCHAR(100) NOT NULL COMMENT '密码',
    employee_id BIGINT NOT NULL COMMENT '关联人员ID',
    status TINYINT DEFAULT 1 COMMENT '状态：0禁用，1启用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_username (username),
    UNIQUE KEY uk_employee_id (employee_id),
    FOREIGN KEY (employee_id) REFERENCES sys_employee(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='用户表';

-- 初始化数据
-- 插入默认部门，使用INSERT IGNORE避免重复插入
INSERT IGNORE INTO sys_dept (dept_name, parent_id, dept_code, sort, status) VALUES
('总公司', 0, '001', 1, 1),
('技术部', 1, '002', 2, 1),
('人事部', 1, '003', 3, 1),
('财务部', 1, '004', 4, 1);

-- 插入默认人员，使用INSERT IGNORE避免重复插入
INSERT IGNORE INTO sys_employee (employee_name, dept_id, employee_code, phone, email, gender, status) VALUES
('管理员', 1, 'EMP001', '13800138000', 'admin@example.com', 1, 1),
('张三', 2, 'EMP002', '13800138001', 'zhangsan@example.com', 1, 1),
('李四', 2, 'EMP003', '13800138002', 'lisi@example.com', 1, 1),
('王五', 3, 'EMP004', '13800138003', 'wangwu@example.com', 2, 1);

-- 插入默认用户，密码为123456（BCrypt加密），使用INSERT IGNORE避免重复插入
INSERT IGNORE INTO sys_user (username, password, employee_id, status) VALUES
('admin', '$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE8ByOhJIrdAu2', 1, 1),
('zhangsan', '$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE8ByOhJIrdAu2', 2, 1),
('lisi', '$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE8ByOhJIrdAu2', 3, 1),
('wangwu', '$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE8ByOhJIrdAu2', 4, 1);

-- 菜单表
CREATE TABLE IF NOT EXISTS sys_menu (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '菜单ID',
    menu_name VARCHAR(50) NOT NULL COMMENT '菜单名称',
    parent_id BIGINT DEFAULT 0 COMMENT '父菜单ID',
    path VARCHAR(100) COMMENT '路由路径',
    component VARCHAR(200) COMMENT '组件路径',
    perm VARCHAR(100) COMMENT '权限标识',
    type TINYINT NOT NULL COMMENT '菜单类型：1目录，2菜单，3按钮',
    icon VARCHAR(50) COMMENT '菜单图标',
    sort INT DEFAULT 0 COMMENT '排序',
    status TINYINT DEFAULT 1 COMMENT '状态：0禁用，1启用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_parent_id (parent_id),
    INDEX idx_type (type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='菜单表';

-- 角色表
CREATE TABLE IF NOT EXISTS sys_role (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '角色ID',
    role_name VARCHAR(50) NOT NULL COMMENT '角色名称',
    role_code VARCHAR(50) NOT NULL COMMENT '角色编码',
    description VARCHAR(200) COMMENT '角色描述',
    status TINYINT DEFAULT 1 COMMENT '状态：0禁用，1启用',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_role_code (role_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='角色表';

-- 用户角色关联表
CREATE TABLE IF NOT EXISTS sys_user_role (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    role_id BIGINT NOT NULL COMMENT '角色ID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UNIQUE KEY uk_user_role (user_id, role_id),
    INDEX idx_user_id (user_id),
    INDEX idx_role_id (role_id),
    FOREIGN KEY (user_id) REFERENCES sys_user(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES sys_role(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='用户角色关联表';

-- 角色菜单关联表
CREATE TABLE IF NOT EXISTS sys_role_menu (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ID',
    role_id BIGINT NOT NULL COMMENT '角色ID',
    menu_id BIGINT NOT NULL COMMENT '菜单ID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    UNIQUE KEY uk_role_menu (role_id, menu_id),
    INDEX idx_role_id (role_id),
    INDEX idx_menu_id (menu_id),
    FOREIGN KEY (role_id) REFERENCES sys_role(id) ON DELETE CASCADE,
    FOREIGN KEY (menu_id) REFERENCES sys_menu(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='角色菜单关联表';

-- 初始化角色数据，使用INSERT IGNORE避免重复插入
INSERT IGNORE INTO sys_role (role_name, role_code, description, status) VALUES
('超级管理员', 'ROLE_ADMIN', '拥有系统所有权限', 1),
('普通用户', 'ROLE_USER', '拥有基础操作权限', 1);

-- 初始化菜单数据，使用INSERT IGNORE避免重复插入
INSERT IGNORE INTO sys_menu (menu_name, parent_id, path, component, perm, type, icon, sort, status) VALUES
('首页', 0, '/dashboard', 'views/Dashboard.vue', '', 1, 'HomeFilled', 1, 1),
('系统管理', 0, '', '', '', 1, 'Setting', 2, 1),
('部门管理', 2, '/dept', 'views/Dept.vue', 'sys:dept:list', 2, 'OfficeBuilding', 1, 1),
('人员管理', 2, '/employee', 'views/Employee.vue', 'sys:employee:list', 2, 'User', 2, 1),
('用户管理', 2, '/user', 'views/User.vue', 'sys:user:list', 2, 'Avatar', 3, 1),
('菜单管理', 2, '/menu', 'views/Menu.vue', 'sys:menu:list', 2, 'Menu', 4, 1),
('角色管理', 2, '/role', 'views/Role.vue', 'sys:role:list', 2, 'DocumentCopy', 5, 1);

-- 初始化用户角色关联，使用INSERT IGNORE避免重复插入
INSERT IGNORE INTO sys_user_role (user_id, role_id) VALUES
(1, 1), -- admin 关联 超级管理员
(2, 2), -- zhangsan 关联 普通用户
(3, 2), -- lisi 关联 普通用户
(4, 2); -- wangwu 关联 普通用户

-- 初始化角色菜单关联（超级管理员拥有所有菜单权限）
INSERT IGNORE INTO sys_role_menu (role_id, menu_id) SELECT 1, id FROM sys_menu;

-- 普通用户拥有首页和系统管理下的基本菜单权限，使用INSERT IGNORE避免重复插入
INSERT IGNORE INTO sys_role_menu (role_id, menu_id) VALUES
(2, 1), -- 首页
(2, 2), -- 系统管理
(2, 3), -- 部门管理
(2, 4), -- 人员管理
(2, 5); -- 用户管理;
